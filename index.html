    <script type="module">
        import { createApp, ref, computed, onMounted, watch } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref as dbRef, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // ðŸŸ¢ æ‚¨çš„ Firebase è¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyA8sysOQedr-G4itsrWzW-i6BfRCLKT_3Q",
            authDomain: "osaka2026-c5974.firebaseapp.com",
            databaseURL: "https://osaka2026-c5974-default-rtdb.firebaseio.com",
            projectId: "osaka2026-c5974",
            storageBucket: "osaka2026-c5974.firebasestorage.app",
            messagingSenderId: "576795484651",
            appId: "1:576795484651:web:72e880993d168436d8b9ae"
        };

        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            console.log("Firebase initialized");
        } catch (e) {
            console.error("Firebase init failed:", e);
        }

        createApp({
            setup() {
                const DB_PATH = 'osaka_trip'; // è³‡æ–™åº«è·¯å¾‘

                const isConnected = ref(false);
                const currentTab = ref('itinerary');
                const currentDayIndex = ref(0);
                const showModal = ref(false);
                const showDetailModal = ref(false);
                const showShoppingModal = ref(false);
                const showExpenseModal = ref(false);
                const showStatsModal = ref(false);
                const showActionModal = ref(false);
                const selectedActionItem = ref({});
                const isEditing = ref(false);
                const isEditingExpense = ref(false);
                const isEditingShopping = ref(false); 
                const editingShoppingIndex = ref(null); 
                const bannerImage = ref('https://images.unsplash.com/photo-1590559374747-8c1e09529b5c?q=80&w=1000&auto=format&fit=crop');
                const selectedDetailItem = ref({});

                const exchangeRate = ref(0.22);
                const calcJpy = ref('');
                const calculatedTwd = computed(() => {
                    return calcJpy.value ? Math.round(calcJpy.value * exchangeRate.value).toLocaleString() : '0';
                });

                const defaultPackingList = [
                    { name: 'é‡è¦è­‰ä»¶èˆ‡éŒ¢åŒ…', items: [{ name: 'è­·ç…§ (æª¢æŸ¥æœŸé™)', checked: false }, { name: 'æ—¥å¹£ç¾é‡‘', checked: false }, { name: 'ä¿¡ç”¨å¡ (é–‹å•Ÿæµ·å¤–ææ¬¾)', checked: false }, { name: 'VJW æˆªåœ–', checked: false }] },
                    { name: 'è¡£ç‰©èˆ‡ä¿æš–', items: [{ name: 'ç¾½çµ¨å¤–å¥—', checked: false }, { name: 'ç™¼ç†±è¡£', checked: false }, { name: 'æ¯›å¸½/æ‰‹å¥—', checked: false }, { name: 'å¥½èµ°çš„éž‹', checked: false }] },
                    { name: '3C èˆ‡è—¥å“', items: [{ name: 'æ‰‹æ©Ÿ/å……é›»ç·š', checked: false }, { name: 'è¡Œå‹•é›»æº (å¿…å‚™)', checked: false }, { name: 'ç¶²å¡é‡', checked: false }, { name: 'å¸¸å‚™è—¥/OKç¹ƒ', checked: false }] }
                ];
                const packingList = ref(JSON.parse(JSON.stringify(defaultPackingList)));
                const newPackingInputs = ref({}); 

                const tripDays = ref([
                    { date: '2/4', weekday: 'Wed', fullDate: '2026-02-04', location: 'å¤§é˜ª/æ¢…ç”°', weather: { temp: 8, feels: 5, icon: 'fa-solid fa-cloud', desc: 'å¤šé›²æ™‚é™°' }, mustBring: 'è­·ç…§ã€VJW æˆªåœ–ã€å¤§è¡ŒæŽç®±(ç©ºä¸€åŠ)ã€è¡Œå‹•é›»æºã€‚' },
                    { date: '2/5', weekday: 'Thu', fullDate: '2026-02-05', location: 'å¤§é˜ª/USJ', weather: { temp: 6, feels: 2, icon: 'fa-solid fa-sun', desc: 'æ™´æ™‚å¤šé›²' }, mustBring: 'USJ APP (å…ˆä¸‹è¼‰)ã€å…©é¡†æ»¿é›»çš„è¡Œå‹•é›»æº (çŽ©é¦¬åŠ›æ­æœƒè€—é›»)ã€æš–æš–åŒ… (æµ·é‚Šé¢¨å¤§)ã€å¸½å­æ‰‹å¥—ã€‚' },
                    { date: '2/6', weekday: 'Fri', fullDate: '2026-02-06', location: 'æœ‰é¦¬æº«æ³‰', weather: { temp: 4, feels: 0, icon: 'fa-regular fa-snowflake', desc: 'å¯èƒ½ä¸‹é›ª' }, mustBring: 'è¼•ä¾¿éŽå¤œåŒ… (æ›æ´—è¡£ç‰©)ã€å„ç¨®å……é›»ç·šã€‚å¤§è¡ŒæŽè¨˜å¾—æ—©ä¸Šå¯„å‡ºï¼' },
                    { date: '2/7', weekday: 'Sat', fullDate: '2026-02-07', location: 'äº¬éƒ½', weather: { temp: 5, feels: 2, icon: 'fa-solid fa-cloud-sun', desc: 'å¤šé›²' }, mustBring: 'ç©ºçš„èƒƒ (åƒéŒ¦å¸‚å ´)ã€å¥½èµ°çš„éž‹ã€‚' },
                    { date: '2/8', weekday: 'Sun', fullDate: '2026-02-08', location: 'äº¬éƒ½', weather: { temp: 7, feels: 4, icon: 'fa-solid fa-sun', desc: 'æ™´æœ—' }, mustBring: 'é˜²æ»‘çš„éž‹ (çŒ´å­å…¬åœ’æ˜¯æ³¥åœŸè·¯)ã€é›¶éŒ¢ (è²·é£¼æ–™é¤µçŒ´å­)ã€‚' },
                    { date: '2/9', weekday: 'Mon', fullDate: '2026-02-09', location: 'é—œè¥¿æ©Ÿå ´', weather: { temp: 9, feels: 6, icon: 'fa-solid fa-cloud', desc: 'å¤šé›²' }, mustBring: 'è­·ç…§ (æ”¾åœ¨å¥½æ‹¿çš„åœ°æ–¹)ã€å‰©é¤˜çš„æ—¥å¹£é›¶éŒ¢ (è½‰æ‰­è›‹)ã€‚' },
                ]);

                // ðŸ“ é€™è£¡æ•´åˆäº†æ‚¨æä¾›çš„ã€å®Œæ•´è©³ç´°è¡Œç¨‹ã€‘
                const defaultItinerary = {
                    0: [ 
                        { id: 1, type: 'flight', category: 'flight', name: 'è¯èˆª CI152', time: '13:20', flightInfo: { depCode: 'TPE', arrCode: 'KIX', number: 'CI152' }, note: 'æ©Ÿä¸Šå…ˆå¡« VJW', desc: 'å°æœ‹å‹è«‹åœ¨é£›æ©Ÿä¸Šç¡é£½ï¼Œä¸‹æ©Ÿå¾Œè¦èµ°å¾ˆå¤šè·¯ï¼è¨˜å¾—æŠŠ VJW çš„ QR Code æˆªåœ–å­˜åœ¨çˆ¸åª½æ‰‹æ©Ÿè£¡ã€‚', transit: null },
                        { id: 2, type: 'normal', category: 'traffic', name: 'å‰å¾€è‡¨ç©ºåŸŽ Outlet', time: '14:50', note: 'JR é—œç©ºå¿«é€Ÿ', desc: 'åªè¦åä¸€ç«™ç«è»Šå°±åˆ°äº†ï¼è¡ŒæŽå¯ä»¥å¯„æ”¾åœ¨è»Šç«™ï¼Œæˆ–æ˜¯Outletè£¡é¢çš„ç½®ç‰©æ«ƒã€‚', transit: { type: 'train', duration: '9åˆ†' } },
                        { id: 3, type: 'normal', category: 'shop', name: 'Rinku Premium Outlets', time: '15:10', businessHours: '10:00-20:00', tags: ['ä¾¿å®œè—¥å¦', 'å¤•é™½'], note: 'é ˜å¤–åœ‹äºº Coupon', 
                          desc: 'ã€Œé€™è£¡æ˜¯å¤§é˜ªæœ€å¤§çš„æµ·é‚Š Outletï¼Œå¾Œé¢å°±æ˜¯å¤§æµ·ï¼Œè²·æ±è¥¿é‚„èƒ½çœ‹æµ·ï¼ã€\nã€Œæˆ‘å€‘å…ˆåŽ»æ‹¿å¤–åœ‹äººå„ªæƒ åˆ¸ï¼Œé€™æ¨£è²·éž‹å­å’Œè¡£æœæ›´ä¾¿å®œï¼ã€\nã€ä¾¿å®œè—¥å¦ã€‘Daikoku (å¤§åœ‹è—¥å¦) åœ¨ Seacle å•†å ´ 1 æ¨“ã€‚', 
                          mustEat: 'Kua Aina å¤å¨å¤·æ¼¢å ¡ (è–¯æ¢å¾ˆç´°å¾ˆå¥½åƒ)ã€Snow Peak Eat (å¯ä»¥åœ¨å¸³ç¯·è£¡åƒé£¯)ã€‚', 
                          mustBuy: 'Skechers (çˆ¸åª½èµ°è·¯ç¥žéž‹)ã€Nikeã€Adidasã€‚', 
                          photoTip: 'ä¸‹åˆ 5:20 åŽ»ã€ŒSea Side Areaã€æµ·é‚Šï¼Œå¯ä»¥æ‹åˆ°æ‘©å¤©è¼ªï¼‹å¤•é™½ï¼‹å¤§æµ·çš„ç„¡æ•µåˆç…§ã€‚',
                          transit: { type: 'walk', duration: '5åˆ†' } },
                        { id: 4, type: 'normal', category: 'traffic', name: 'å‰å¾€å¤§é˜ªæ¢…ç”°', time: '18:30', note: 'å‰ 4 ç¯€è»Šå»‚', desc: 'æ³¨æ„ï¼ç«è»Šæœƒã€Œåˆ†èº«ã€ï¼Œä¸€å®šè¦ååœ¨ç¬¬ 1 åˆ°ç¬¬ 4 ç¯€è»Šå»‚ï¼Œä¸ç„¶æœƒè¢«è¼‰åŽ»åˆ¥çš„åœ°æ–¹å–”ã€‚', transit: { type: 'train', duration: '55åˆ†' } },
                        { id: 5, type: 'normal', category: 'hotel', name: 'Check-in: Vischio Osaka', time: '19:30', note: 'æ¢…ç”°è¿·å®®æ”»ç•¥', desc: 'ã€æ¢…ç”°å¤§è¿·å®®ã€‘ä¸è¦èµ°åœ°ä¸‹è¡—ï¼å‡ºä¾†å¾Œæ‰¾ã€Œ2æ¨“å¤©æ©‹ã€ï¼Œå¾ž Grand Front ç©¿éŽåŽ»å°±åˆ°äº†ã€‚', transit: { type: 'walk', duration: '10åˆ†' } },
                        { id: 6, type: 'normal', category: 'food', name: 'è—å£½å¸ æ¢…ç”°æ——è‰¦åº—', time: '20:00', tags: ['è¦ªå­å‹å–„'], note: 'å¯é ç´„', 
                          desc: 'ã€åœ‹å°ç”Ÿçœ‹é»žã€‘é€™å®¶æ˜¯å…¨ä¸–ç•Œæœ€å¤§çš„è—å£½å¸ï¼æœ‰ç¥­å…¸éŠæˆ²å¯ä»¥çŽ©ï¼Œç›¤å­ä¸Ÿé€²åŽ»å¯ä»¥æŠ½æ‰­è›‹ã€‚', 
                          mustEat: 'ç‚™ç‡’é®­é­šã€èŒ¶ç¢—è’¸ (æ—¥æœ¬çš„ç‰¹åˆ¥å¥½åƒ)ã€‚', 
                          photoTip: 'å…¥å£æœ‰ä¸€é¢å·¨å¤§çš„ã€Œå½©è‰²ç‡ˆç± ç‰†ã€ï¼Œä¸€å®šè¦åœ¨é€™è£¡æ‹å…¨å®¶ç¦ã€‚',
                          transit: { type: 'walk', duration: '5åˆ†' } }
                    ],
                    1: [
                        { id: 10, type: 'normal', category: 'traffic', name: 'å‡ºç™¼å‰å¾€ USJ', time: '07:00', note: 'JR ç’°ç‹€ç·š->å¤¢å’²ç·š', desc: 'è·Ÿè‘—äººç¾¤èµ°å°±å°äº†ï¼å¤§å®¶éƒ½è¦åŽ»ç’°çƒå½±åŸŽã€‚', transit: { type: 'train', duration: '30åˆ†' } },
                        { id: 11, type: 'normal', category: 'sight', name: 'USJ å…¥åœ’ & æŠ½æ•´ç†åˆ¸', time: '07:45', ticket: 'QR Code', note: 'ç«‹åˆ»æŠ½ç‘ªåˆ©æ­', 
                          desc: 'ã€Œé€™è£¡æ˜¯ç’°çƒå½±åŸŽï¼Œè£¡é¢æœ‰å°å°å…µã€ç‘ªåˆ©æ­å’Œå“ˆåˆ©æ³¢ç‰¹ï¼Œè¶…ç´šå¥½çŽ©ï¼ã€\n\nã€é‡é»žã€‘ä¸€é€²é–€çˆ¸çˆ¸åª½åª½è¦è¶•å¿«ç”¨æ‰‹æ©ŸæŠ½ã€Œç‘ªåˆ©æ­æ¨‚åœ’ã€çš„è™Ÿç¢¼ç‰Œã€‚', 
                          mustBuy: 'èƒ½é‡æ‰‹ç’° (å¯ä»¥æ•²é‡‘ç£šè³ºé‡‘å¹£)ã€æ˜Ÿæ˜Ÿçˆ†ç±³èŠ±æ¡¶ (æœƒç™¼å…‰)ã€‚', 
                          photoTip: 'ä¸€é€²é–€çš„å¤§åœ°çƒðŸŒæ˜¯å¿…æ‹ï¼Œè«‹è·¯äººå¹«å¿™æ‹åˆç…§ï¼Œç¨å¾®ç”±ä¸‹å¾€ä¸Šæ‹è…¿æœƒæ¯”è¼ƒé•·ã€‚',
                          transit: { type: 'walk', duration: '5åˆ†' } },
                        { id: 12, type: 'normal', category: 'sight', name: 'å°å°å…µ & è¦ªå­å€', time: '08:30', note: 'èº«é«˜é™åˆ¶æ³¨æ„', 
                          desc: 'ã€åœ‹å°ç”Ÿçœ‹é»žã€‘å°å°å…µæœƒå‡ºä¾†æƒ¡ä½œåŠ‡ï¼ã€Œå°å°å…µä¹˜è»ŠéŠã€å¦‚æžœèº«é«˜ä¸å¤  (102cm)ï¼Œå¯ä»¥åŽ»æ—é‚Šçš„ã€Œç’°çƒå¥‡å¢ƒã€é–‹å²åŠªæ¯”é£›æ©Ÿã€‚', 
                          mustEat: 'å°å°å…µå¤¾å¿ƒé¤…ä¹¾ (Minion Cookie Sand)ã€‚', 
                          transit: { type: 'walk', duration: '10åˆ†' } },
                        { id: 13, type: 'normal', category: 'food', name: 'å¿«æ¨‚å’–å•¡å»³åˆé¤', time: '11:00', note: 'Happiness Cafe', 
                          desc: 'é€™è£¡æœ‰é£²æ–™å–åˆ°é£½ï¼ä¼‘æ¯ä¸€ä¸‹ï¼Œä¸Šå€‹å»æ‰€ï¼Œæº–å‚™ä¸‹åˆå†æˆ°ã€‚', 
                          mustEat: 'å°å°å…µæ¼¢å ¡é¤ (é€ åž‹å¾ˆå¯æ„›)ã€‚', 
                          transit: { type: 'walk', duration: '5åˆ†' } },
                        { id: 14, type: 'normal', category: 'sight', name: 'NO LIMIT! Parade', time: '14:00', note: 'éŠè¡Œ', desc: 'ã€ŒéŠè¡Œé–‹å§‹äº†ï¼å¤§å®¶å¿«çœ‹ï¼Œç‘ªåˆ©æ­å’Œçš®å¡ä¸˜åœ¨è·³èˆžï¼ã€', transit: { type: 'walk', duration: '0åˆ†' } },
                        { id: 15, type: 'normal', category: 'sight', name: 'è¶…ç´šä»»å¤©å ‚ä¸–ç•Œ', time: '15:30', note: 'éœ€æ†‘åˆ¸å…¥å ´', 
                          desc: 'ã€Œé€™å€‹æ‰‹ç’°å¯ä»¥æ”¶é›†é‡‘å¹£ï¼ŒåƒçœŸçš„åœ¨æ‰“é›»å‹•ä¸€æ¨£ï¼ã€\n\nã€æ³¨æ„ã€‘ä¸€å®šè¦é‡èº«é«˜ï¼Œå·®1å…¬åˆ†ä¹Ÿä¸èƒ½çŽ©è³½è»Šå–”ã€‚', 
                          mustEat: 'å¥‡è«¾æ¯”å¥§é¤å»³ (è˜‘è‡æ¿ƒæ¹¯)ã€‚', 
                          photoTip: 'åœ¨ç¶ è‰²æ°´ç®¡è£¡é¢æ‹ç…§ï¼Œåƒå‰›å¾žæ°´ç®¡é‘½å‡ºä¾†ä¸€æ¨£ã€‚',
                          transit: { type: 'walk', duration: '15åˆ†' } },
                        { id: 16, type: 'normal', category: 'sight', name: 'å“ˆåˆ©æ³¢ç‰¹ç¦å¿Œä¹‹æ—…', time: '18:00', note: 'èº«é«˜122cm', 
                          desc: 'ã€åœ‹å°ç”Ÿçœ‹é»žã€‘æœ‰çœŸçš„è²“é ­é·¹ï¼æ™šä¸Šçš„éœæ ¼è¯èŒ²åŸŽå ¡æœƒç™¼å…‰ï¼Œè¶…ç´šæ¼‚äº®ã€‚', 
                          mustEat: 'å¥¶æ²¹å•¤é…’ (é€™æ˜¯æ²’æœ‰é…’ç²¾çš„æ±½æ°´ï¼Œå°æœ‹å‹å¯ä»¥å–ï¼Œå˜´å·´æœƒæœ‰ç™½é¬å­)ã€‚', 
                          photoTip: 'åŽ»ã€Œä¸‰æ ¹æŽƒå¸šã€é¤å»³å¾Œé¢çš„æˆ¶å¤–åº§ä½ï¼Œå¯ä»¥æ‹åˆ°æœ€å®Œæ•´çš„åŸŽå ¡å€’å½±ï¼Œé‚„æ²’æœ‰äººæ“ äººã€‚',
                          transit: { type: 'walk', duration: '10åˆ†' } },
                        { id: 17, type: 'normal', category: 'food', name: '551 è“¬èŠè‚‰åŒ…', time: '20:30', note: 'å®µå¤œ', desc: 'åœ¨è»Šç«™å¤–é¢è²·å¤§é˜ªæœ€æœ‰åçš„è‚‰åŒ…å›žé£¯åº—åƒã€‚', transit: { type: 'train', duration: '30åˆ†' } }
                    ],
                    2: [
                        { id: 20, type: 'normal', category: 'other', name: 'ã€é‡è¦ã€‘è¡ŒæŽè¨—é‹', time: '08:30', note: 'å¯„å¾€äº¬éƒ½é£¯åº—', desc: 'çˆ¸çˆ¸åª½åª½æ³¨æ„ï¼šæŠŠå¤§è¡ŒæŽç®±å¯„åŽ»äº¬éƒ½ï¼Œæˆ‘å€‘åªå¸¶ä¸€å€‹å°åŒ…åŒ…åŽ»æº«æ³‰æ—…é¤¨ï¼ŒåƒåŽ»éœ²ç‡Ÿä¸€æ¨£è¼•é¬†ï¼\n\nã€å¡«å–®é‡é»ž - çµ¦æ«ƒæª¯çœ‹ã€‘\næ”¶ä»¶äºº: Daiwa Roynet Hotel Kyoto Terrace Hachijo (Front Desk)\nåœ°å€: 14-1 Higashikujo Higashisannocho, Minami Ward, Kyoto, 601-8004æ—¥æœ¬\né›»è©±: +81 75-682-0855\nå‚™è¨»: Check-in 2/7, Guest: LAI YOU WEN, Res No: 1616327071949495\nðŸ”´ é…é”æ—¥: 2026/02/06 or 2026/02/07', transit: { type: 'walk', duration: '5åˆ†' } },
                        { id: 21, type: 'normal', category: 'sight', name: 'å¤§é˜ªåŸŽå…¬åœ’', time: '09:30', note: 'æ­å°ç«è»Š', 
                          desc: 'ã€Œé€™æ˜¯å¤§é˜ªåŸŽï¼Œå››ç™¾å¤šå¹´å‰è±è‡£ç§€å‰è“‹çš„ï¼Œè£¡é¢æœ‰å¥½å¤šæ­¦å£«çš„æ•…äº‹ï¼ã€\nã€Œç«™åœ¨å¤©å®ˆé–£ä¸Šå¯ä»¥çœ‹åˆ°æ•´å€‹å¤§é˜ªï¼Œå¥½åƒå°é³¥åœ¨å¤©ç©ºçœ‹åŸŽå¸‚ï¼ã€', 
                          mustEat: 'ç« é­šç‡’ (å…¬åœ’åº—)ã€‚', 
                          photoTip: 'ä¸è¦ç«™åœ¨åŸŽå ¡æ­£ä¸‹æ–¹æ‹ï¼Œäººæœƒè®Šå¾ˆå°ã€‚ç«™åœ¨è­·åŸŽæ²³çš„æ©‹ä¸Šæ‹ï¼Œäººè·ŸåŸŽå ¡éƒ½å¾ˆæ¸…æ¥šã€‚',
                          transit: { type: 'train', duration: '20åˆ†' } },
                        { id: 22, type: 'normal', category: 'traffic', name: 'å‰å¾€æœ‰é¦¬æº«æ³‰', time: '13:30', note: 'é˜ªæ€¥é«˜é€Ÿå·´å£«', desc: 'ã€ç›´é”å·´å£«ã€‘å¾žæ¢…ç”°é˜ªæ€¥ä¸‰ç•ªè¡—å·´å£«ç¸½ç«™å‡ºç™¼ï¼Œç›´é”æœ‰é¦¬æº«æ³‰ï¼Œå®Œå…¨ä¸ç”¨è½‰è»Šï¼', transit: { type: 'car', duration: '60åˆ†' } },
                        { id: 23, type: 'normal', category: 'hotel', name: 'Check-in: æœ‰é¦¬å…µè¡›å‘é™½é–£', time: '15:00', note: 'é‡‘éŠ€é›™æ¹¯', 
                          desc: 'ã€Œé€™è£¡æ˜¯æœ‰é¦¬æº«æ³‰ï¼Œæ—¥æœ¬æœ€å¤è€çš„æº«æ³‰ä¹‹ä¸€ï¼ã€\nã€Œé‡‘ä¹‹æ¹¯çš„æ°´æ˜¯ç´…è‰²çš„ï¼ŒéŠ€ä¹‹æ¹¯çš„æ°´æ˜¯é€æ˜Žçš„ï¼Œå…©ç¨®éƒ½å¾ˆç‰¹åˆ¥ï¼ã€', 
                          mustEat: 'æ™šé¤åƒè¶…ç´šé«˜ç´šçš„æ‡·çŸ³æ–™ç† (æœ‰ç‰›è‚‰)ã€‚', 
                          mustBuy: 'ç¢³é…¸å…¥æµ´åŠ‘ (å¯ä»¥è²·å›žå®¶æ³¡æ¾¡)ã€‚',
                          photoTip: 'ç©¿è‘—é£¯åº—çš„æµ´è¡£åœ¨æˆ¿é–“çª—é‚Šæ‹ç…§ï¼Œå¾ˆæœ‰æ—¥æœ¬å¡é€šçš„æ„Ÿè¦ºã€‚',
                          transit: { type: 'walk', duration: '10åˆ†' } }
                    ],
                    3: [
                        { id: 30, type: 'normal', category: 'sight', name: 'æœ‰é¦¬æº«æ³‰è¡—æ•£ç­–', time: '09:30', note: 'è³žå‘³æœŸé™5ç§’', 
                          desc: 'ã€Œé€™å€‹ç…Žé¤…è¦è¶ç†±åƒï¼Œäº”ç§’å°±ä¸è„†äº†ï¼ã€\n\nã€ä»»å‹™ã€‘åŽ»ã€Œä¸‰æ´¥æ£®æœ¬é‹ªã€æŒ‘æˆ°è€é—†å‰›çƒ¤å¥½çš„è»Ÿç…Žé¤…ï¼', 
                          mustEat: 'ç¾çƒ¤ç¢³é…¸ç…Žé¤…ã€æº«æ³‰é¥…é ­ã€‚', 
                          transit: { type: 'walk', duration: '20åˆ†' } },
                        { id: 31, type: 'normal', category: 'traffic', name: 'ç›´é”äº¬éƒ½è»Šç«™', time: '13:00', note: 'é˜ªæ€¥/äº¬é˜ªå·´å£«', desc: 'ã€ç›´é”å·´å£«ã€‘å¾žæœ‰é¦¬æº«æ³‰ç›´é”äº¬éƒ½è»Šç«™å…«æ¢å£ï¼Œä¸‹è»Šå°±æ˜¯é£¯åº—ï¼Œä¸ç”¨æ¬è¡ŒæŽè½‰è»Šï¼', transit: { type: 'car', duration: '75åˆ†' } },
                        { id: 32, type: 'normal', category: 'hotel', name: 'Check-in: Daiwa Roynet', time: '15:00', tags: ['ä¾¿å®œè—¥å¦'], note: 'ç¢ºèªè¡ŒæŽ', 
                          desc: 'æˆ‘å€‘çš„è¡ŒæŽå·²ç¶“åœ¨é£¯åº—ç­‰æˆ‘å€‘äº†ï¼\nã€ä¾¿å®œè—¥å¦ã€‘é£¯åº—å°é¢æœ‰ä¸€é–“å¾ˆå¤§çš„ã€ŒDon Quijote (å”å‰è¨¶å¾·)ã€ï¼Œæ™šä¸Šå¯ä»¥åŽ»æŽ¢éšªã€‚', 
                          transit: { type: 'walk', duration: '3åˆ†' } },
                        { id: 33, type: 'normal', category: 'shop', name: 'éŒ¦å¸‚å ´', time: '16:00', note: '17:00 æ”¶æ”¤', 
                          desc: 'ã€Œé€™è£¡æ˜¯äº¬éƒ½çš„å»šæˆ¿ï¼Œä»€éº¼å°åƒéƒ½æœ‰ï¼ã€\nã€Œæˆ‘æœ€å–œæ­¡è±†ä¹³ç”œç”œåœˆï¼Œå¤–é¢è„†è„†çš„ï¼Œè£¡é¢è»Ÿè»Ÿçš„ï¼ã€\n\nã€æ³¨æ„ã€‘è²·äº†è¦åœ¨åº—é–€å£åƒå®Œï¼Œä¸èƒ½é‚Šèµ°é‚Šåƒå–”ã€‚', 
                          mustEat: 'å¯Œç¾Žå®¶é‹ç‡’çƒé¾éºµ (å¾ˆå¤šæ–™)ã€å²åŠªæ¯”èŒ¶å±‹ (å¯æ„›é¥…é ­)ã€è±†ä¹³ç”œç”œåœˆã€‚', 
                          mustBuy: 'èˆžå¦“å’–å“©ä»™è² (è¾£è¾£çš„å¾ˆå¥½åƒ)ã€‚', 
                          transit: { type: 'car', duration: '20åˆ†' } }
                    ],
                    4: [
                        { id: 40, type: 'normal', category: 'sight', name: 'åµå±±çŒ´å­å…¬åœ’', time: '09:00', note: 'éœ€çˆ¬å±±20åˆ†', 
                          desc: 'ã€ŒçŒ´å­åœ¨å¤–é¢è‡ªç”±èµ°ï¼Œäººè¦åœ¨ç± å­è£¡é¤µç‰ å€‘ï¼Œå¥½ç‰¹åˆ¥ï¼ã€\nã€Œçˆ¬åˆ°å±±é ‚å¯ä»¥çœ‹åˆ°æ•´å€‹äº¬éƒ½ï¼Œè¶…ç´šç¾Žï¼ã€', 
                          mustEat: 'å±±é ‚è²©è³£éƒ¨çš„è˜‹æžœåˆ‡ç‰‡(é¤µçŒ´å­ç”¨ï¼Œä¸èƒ½è‡ªå·±åƒXD)ã€‚', 
                          photoTip: 'è·ŸçŒ´å­åˆç…§æ™‚ã€Œçœ¼ç›ä¸è¦ä¸€ç›´ç›¯è‘—çŒ´å­çœ¼ç›çœ‹ã€ï¼Œç‰ å€‘æœƒä»¥ç‚ºä½ è¦åµæž¶ã€‚çœ‹é¡é ­å°±å¥½ï¼',
                          transit: { type: 'train', duration: 'JR 16åˆ†' } },
                        { id: 41, type: 'normal', category: 'sight', name: 'åµå±±ç«¹æž— & åµé›»é«”é©—', time: '11:30', note: 'åˆé¤+æ•£æ­¥', 
                          desc: 'ã€ç«¹æž—ã€‘ã€Œé€™è£¡æ˜¯ç«¹æž—å°å¾‘ï¼Œèµ°é€²ä¾†å°±åƒé€²å…¥ç¶ è‰²çš„éš§é“ï¼ã€ã€Œé¢¨å¹éŽç«¹å­æœƒç™¼å‡ºæ²™æ²™è²ï¼Œå¥½åƒåœ¨å”±æ­Œï¼ã€\n\nã€åµé›»ã€‘ã€Œé€™æ˜¯åµé›»ï¼Œäº¬éƒ½å”¯ä¸€çš„è·¯é¢é›»è»Šï¼Œæœƒåœ¨é¦¬è·¯ä¸Šç­‰ç´…ç¶ ç‡ˆï¼ã€ã€Œé›»è»Šæ˜¯ç´«è‰²çš„ï¼Œå¥½å¯æ„›ï¼ã€', 
                          mustEat: 'ARABICA å’–å•¡ (çˆ¸åª½å–)ã€ç±³é£›å…”éºµåŒ… (å°æœ‹å‹åƒ)ã€‚', 
                          transit: { type: 'walk', duration: '15åˆ†' } },
                        { id: 42, type: 'normal', category: 'sight', name: 'é‡‘é–£å¯º', time: '15:00', businessHours: '09:00-17:00', note: 'å¤•é™½é‡‘é–£', 
                          desc: 'ã€Œé€™æ˜¯é‡‘é–£å¯ºï¼Œæ•´åº§å¯ºå»Ÿéƒ½è²¼æ»¿é‡‘ç®”ï¼Œé–ƒé–ƒç™¼äº®ï¼ã€\nã€Œä¸‹åˆçš„é™½å…‰ç…§åœ¨é‡‘é–£å¯ºä¸Šï¼Œåƒä¸€é¡†é‡‘è‰²çš„å¯¶çŸ³ï¼ã€\nã€Œé€™è£¡æœ‰é‡‘ç®”å†°æ·‡æ·‹ï¼Œåƒèµ·ä¾†é–ƒé–ƒçš„ï¼Œå¥½é…·ï¼ã€', 
                          mustEat: 'é‡‘ç®”å†°æ·‡æ·‹ (å˜´å·´æœƒé‡‘é‡‘çš„)ã€‚', 
                          mustBuy: 'é‡‘é–£å¯ºå¾¡å®ˆ (ä¿ä½‘è€ƒè©¦100åˆ†)ã€‚', 
                          photoTip: 'ä¸€å®šè¦æ‹åˆ°ã€Œæ°´é‡Œé¢çš„é‡‘é–£å¯ºå€’å½±ã€ï¼Œé‚£æ‰æ˜¯æœ€åŽ²å®³çš„ç…§ç‰‡ã€‚',
                          transit: { type: 'train', duration: 'åµé›»+Bus 40åˆ†' } },
                        { id: 43, type: 'normal', category: 'food', name: 'æ‹‰éºµå°è·¯æ™šé¤', time: '17:30', note: 'äº¬éƒ½è»Šç«™10F', 
                          desc: 'ã€å¸‚ç‡Ÿå·´å£« 205ã€‘å¾žé‡‘é–£å¯ºé“ç›´é”äº¬éƒ½è»Šç«™ã€‚é€™è£¡æœ‰å…¨æ—¥æœ¬æœ€å¥½åƒçš„æ‹‰éºµé›†åˆï¼', 
                          transit: { type: 'car', duration: '45åˆ†' } }
                    ],
                    5: [
                        { id: 50, type: 'normal', category: 'traffic', name: 'å‰å¾€é—œè¥¿æ©Ÿå ´', time: '09:30', note: 'åˆ©æœ¨æ´¥å·´å£«', desc: 'ã€ç›´é”å·´å£«ã€‘å¾žé£¯åº—å°é¢çš„å…«æ¢å£æ­ä¹˜ã€Œåˆ©æœ¨æ´¥å·´å£«ã€ï¼Œä¸ç”¨æ‹–è¡ŒæŽåŽ»æ“ ç«è»Šï¼Œä¸Šè»Šç¡è¦ºç›´é”æ©Ÿå ´ï¼', transit: { type: 'car', duration: '88åˆ†' } },
                        { id: 51, type: 'flight', category: 'flight', name: 'æ˜Ÿå®‡ JX823', time: '14:00', flightInfo: { depCode: 'KIX', arrCode: 'TPE', number: 'JX823' }, tags: ['2026å¿…è²·'], note: 'T1 ç™»æ©Ÿ', 
                          desc: 'ã€æœ€å¾Œè¡åˆºã€‘æŠŠå‰©ä¸‹çš„é›¶éŒ¢å…¨éƒ¨æ‹¿åŽ»è½‰æ‰­è›‹ï¼\nã€2026 å¿…è²·ä¼´æ‰‹ç¦®ã€‘\n1. Grand Calbee (é«˜ç´šåŽšæ´‹èŠ‹ç‰‡)\n2. BÃ¢ton d\'or (è²´å©¦ Pocky)\n3. è–¯æ¢ä¸‰å…„å¼Ÿ (è¬å¹´ä¸æ•—)\n4. ROYCE ç”Ÿå·§å…‹åŠ› (è¦è²·ä¿å†°è¢‹)', 
                          mustBuy: 'æ‰­è›‹æ©Ÿ (æŠŠé›¶éŒ¢èŠ±å…‰)ã€‚', 
                          transit: { type: 'walk', duration: '10åˆ†' } }
                    ]
                };

                const itineraryData = ref(JSON.parse(JSON.stringify(defaultItinerary))); // åˆå§‹åŒ–å°±è¼‰å…¥è³‡æ–™

                const flightInfos = [
                    { type: 'åŽ»ç¨‹', date: '2026/2/4', dep: 'TPE', arr: 'KIX', depTime: '13:20', arrTime: '16:50', duration: '2h35m', code: 'CI152', terminal: 'æ¡ƒæ©Ÿ T2 / é—œè¥¿ T1' },
                    { type: 'å›žç¨‹', date: '2026/2/9', dep: 'KIX', arr: 'TPE', depTime: '14:00', arrTime: '16:15', duration: '3h15m', code: 'JX823', terminal: 'é—œè¥¿ T1 / æ¡ƒæ©Ÿ T1' }
                ];
                
                const hotelInfos = [
                    { name: 'Hotel Vischio Osaka', engName: 'by Granvia', address: 'å¤§é˜ªåºœå¤§é˜ªå¸‚åŒ—å€èŠç”°2ä¸ç›®4-10', booker: 'Lai You Wen', platform: 'Agoda' },
                    { name: 'æœ‰é¦¬å…µè¡›å‘é™½é–£', engName: 'Arima Onsen Hyoe Koyokaku', address: 'å…µåº«çœŒç¥žæˆ¸å¸‚åŒ—åŒºæœ‰é¦¬ç”º1904', booker: 'Li Gen Liang', platform: 'å®˜ç¶²' },
                    { name: 'Daiwa Roynet Hotel', engName: 'Kyoto Terrace Hachijo PREMIER', address: 'äº¬éƒ½å¸‚å—åŒºæ±ä¹æ¡æ±å±±çŽ‹ç”º14-1', booker: 'Lai You Wen', platform: 'Trip' }
                ];

                const modalForm = ref({});
                const shoppingList = ref([]);
                const shoppingForm = ref({ name: '', image: null });
                const expenses = ref([]);
                const expenseForm = ref({ id: null, category: 'é£²é£Ÿ', name: '', amount: '', paymentType: 'ç¾é‡‘', customName: '', date: '' });

                const currentDayItinerary = computed(() => itineraryData.value[currentDayIndex.value] || []);
                const totalExpenses = computed(() => expenses.value.reduce((sum, item) => sum + item.amount, 0));
                const cashTotal = computed(() => expenses.value.filter(i => i.method === 'ç¾é‡‘' || i.paymentType === 'ç¾é‡‘').reduce((sum, item) => sum + item.amount, 0));
                const cardTotal = computed(() => expenses.value.filter(i => (i.method !== 'ç¾é‡‘' && i.paymentType !== 'ç¾é‡‘')).reduce((sum, item) => sum + item.amount, 0));
                
                const cardBreakdown = computed(() => {
                    const breakdown = {};
                    expenses.value.forEach(item => {
                        let key = item.method;
                        if (item.paymentType) { if (item.paymentType === 'ç¾é‡‘') key = 'ç¾é‡‘'; else key = item.customName || 'ä¿¡ç”¨å¡'; }
                        breakdown[key] = (breakdown[key] || 0) + item.amount;
                    });
                    return breakdown;
                });
                
                const usedCards = computed(() => {
                    const cards = new Set();
                    expenses.value.forEach(item => {
                        if(item.paymentType === 'ä¿¡ç”¨å¡' && item.customName) cards.add(item.customName);
                        if(item.method !== 'ç¾é‡‘' && item.method !== 'ä¿¡ç”¨å¡' && item.method) cards.add(item.method);
                    });
                    return Array.from(cards);
                });
                
                const categoryBreakdown = computed(() => {
                    const breakdown = {};
                    expenses.value.forEach(item => { breakdown[item.category] = (breakdown[item.category] || 0) + item.amount; });
                    return breakdown;
                });

                const getCategoryIcon = (cat) => { const map = { sight: 'fa-camera', food: 'fa-utensils', shop: 'fa-bag-shopping', hotel: 'fa-bed', traffic: 'fa-train-subway', flight: 'fa-plane', other: 'fa-circle' }; return `fa-solid ${map[cat] || 'fa-circle'}`; };
                const getCategoryColor = (cat) => { const map = { sight: 'bg-orange-400', food: 'bg-red-400', shop: 'bg-purple-400', hotel: 'bg-blue-400', traffic: 'bg-gray-400', flight: 'bg-sky-500', other: 'bg-slate-400' }; return map[cat] || 'bg-slate-400'; };
                const getTransitIcon = (type) => { if(type === 'walk') return 'fa-solid fa-person-walking'; if(type === 'car') return 'fa-solid fa-bus'; if(type === 'hotel') return 'fa-solid fa-bed'; return 'fa-solid fa-train-subway'; };
                const getExpenseIcon = (cat) => { const map = { 'é£²é£Ÿ': 'fa-utensils', 'äº¤é€š': 'fa-train', 'è³¼ç‰©': 'fa-bag-shopping', 'é–€ç¥¨': 'fa-ticket', 'ä½å®¿': 'fa-bed', 'å…¶ä»–': 'fa-circle' }; return `fa-solid ${map[cat] || 'fa-circle'}`; };
                const getExpenseColor = (cat) => { const map = { 'é£²é£Ÿ': 'bg-red-400', 'äº¤é€š': 'bg-gray-400', 'è³¼ç‰©': 'bg-purple-400', 'é–€ç¥¨': 'bg-orange-400', 'ä½å®¿': 'bg-blue-400', 'å…¶ä»–': 'bg-slate-400' }; return map[cat] || 'bg-slate-400'; };

                const cleanName = (name) => {
                    return name.replace(/Check-in:\s*/i, '').replace(/^å‰å¾€/, '').replace(/ã€.*?ã€‘/g, '').replace(/ï¼ˆ.*?ï¼‰/g, '').trim();
                };

                const openMap = (keyword) => {
                    const url = 'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(cleanName(keyword));
                    window.open(url, '_blank');
                };

                const openRoute = (index) => {
                    const list = currentDayItinerary.value;
                    const destination = cleanName(list[index].name);
                    let origin = '';
                    let mode = 'transit'; 
                    const type = list[index].transit?.type || 'train';
                    if (type === 'car') mode = 'driving'; else if (type === 'walk') mode = 'walking';
                    
                    if (index > 0) { 
                        const prevItem = list[index - 1]; 
                        if (prevItem.type === 'flight') origin = 'Kansai International Airport'; 
                        else origin = cleanName(prevItem.name); 
                    } else { 
                        const hotels = ['', 'Hotel Vischio Osaka', 'Hotel Vischio Osaka', 'Arima Onsen Hyoe Koyokaku', 'Daiwa Roynet Hotel Kyoto Terrace Hachijo', 'Daiwa Roynet Hotel Kyoto Terrace Hachijo' ]; 
                        origin = hotels[currentDayIndex.value] || 'Current Location'; 
                    }
                    const url = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}&travelmode=${mode}`;
                    window.open(url, '_blank');
                };

                const openDetail = (item) => { selectedDetailItem.value = item; showDetailModal.value = true; };
                
                const openAddModal = () => { isEditing.value = false; modalForm.value = { category: 'sight', transitType: 'walk', startTime: '10:00', name: '', note: '', businessHours: '', ticket: '' }; showModal.value = true; };
                
                const closeModal = () => { showModal.value = false; };
                const openActionModal = (item) => { selectedActionItem.value = item; showActionModal.value = true; };
                const triggerEdit = () => { showActionModal.value = false; editItem(selectedActionItem.value); };
                const triggerDelete = () => { showActionModal.value = false; confirmDeleteItem(selectedActionItem.value); };
                const editItem = (item) => { isEditing.value = true; modalForm.value = JSON.parse(JSON.stringify(item)); modalForm.value.startTime = item.time; modalForm.value.transitType = item.transit ? item.transit.type : 'train'; showModal.value = true; };
                const confirmDeleteItem = (item) => { if(confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${item.name}ã€å—Žï¼Ÿåˆªé™¤å¾Œç„¡æ³•å¾©åŽŸã€‚`)) { const dayList = itineraryData.value[currentDayIndex.value]; const idx = dayList.findIndex(i => i.id === item.id); if(idx !== -1) dayList.splice(idx, 1); saveToStorage(); } };

                const saveItem = () => { 
                    const dayList = itineraryData.value[currentDayIndex.value]; 
                    const newItem = { 
                        id: isEditing.value ? modalForm.value.id : Date.now(), 
                        type: modalForm.value.category === 'flight' ? 'flight' : 'normal', 
                        category: modalForm.value.category, 
                        name: modalForm.value.name || 'æœªå‘½åè¡Œç¨‹', 
                        time: modalForm.value.startTime || '00:00',
                        businessHours: modalForm.value.businessHours || '', 
                        ticket: modalForm.value.ticket || '', 
                        note: modalForm.value.note || '', 
                        tags: dayList.find(i => i.id === modalForm.value.id)?.tags || [],
                        desc: dayList.find(i => i.id === modalForm.value.id)?.desc || '',
                        mustEat: dayList.find(i => i.id === modalForm.value.id)?.mustEat || '',
                        mustBuy: dayList.find(i => i.id === modalForm.value.id)?.mustBuy || '',
                        photoTip: dayList.find(i => i.id === modalForm.value.id)?.photoTip || '',
                        transit: isEditing.value && dayList.find(i => i.id === modalForm.value.id)?.transit ? { ...dayList.find(i => i.id === modalForm.value.id).transit, type: modalForm.value.transitType } : (currentDayIndex.value === 0 && dayList.length === 0 ? null : { type: modalForm.value.transitType }), 
                        flightInfo: modalForm.value.category === 'flight' ? { depCode: 'XXX', arrCode: 'XXX', number: 'FLIGHT' } : null 
                    }; 
                    
                    if (isEditing.value) { const idx = dayList.findIndex(i => i.id === newItem.id); dayList[idx] = newItem; } else { dayList.push(newItem); } 
                    dayList.sort((a, b) => a.time.localeCompare(b.time)); 
                    saveToStorage(); 
                    showModal.value = false; 
                };
                
                const deleteItem = () => { confirmDeleteItem(modalForm.value); showModal.value = false; };
                const moveItem = (index, direction) => { const list = itineraryData.value[currentDayIndex.value]; const targetIndex = index + direction; if (targetIndex >= 0 && targetIndex < list.length) { [list[index], list[targetIndex]] = [list[targetIndex], list[index]]; saveToStorage(); } };
                
                const openShoppingModal = () => { isEditingShopping.value = false; shoppingForm.value = { name: '', image: null }; showShoppingModal.value = true; };
                const editShoppingItem = (item, idx) => { isEditingShopping.value = true; editingShoppingIndex.value = idx; shoppingForm.value = { ...item }; showShoppingModal.value = true; };
                const handleImageUpload = (e) => { const file = e.target.files[0]; if(file) { const reader = new FileReader(); reader.onload = (e) => shoppingForm.value.image = e.target.result; reader.readAsDataURL(file); } };
                const addShoppingItem = () => { if(shoppingForm.value.name) { if(isEditingShopping.value) { shoppingList.value[editingShoppingIndex.value] = { ...shoppingForm.value }; } else { shoppingList.value.push({ ...shoppingForm.value }); } saveToStorage(); showShoppingModal.value = false; } };
                const removeShoppingItem = (idx) => { if(confirm('åˆªé™¤æ­¤å•†å“ï¼Ÿ')) { shoppingList.value.splice(idx, 1); saveToStorage(); } };
                const deleteShoppingItem = () => { if(confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å•†å“ï¼Ÿ')) { shoppingList.value.splice(editingShoppingIndex.value, 1); saveToStorage(); showShoppingModal.value = false; } };

                const savePackingList = () => { saveToStorage(); };
                const resetPackingList = () => { if(confirm('ç¢ºå®šè¦é‡ç½®ç‚ºé è¨­æ¸…å–®å—Žï¼Ÿ')) { packingList.value = JSON.parse(JSON.stringify(defaultPackingList)); savePackingList(); } };
                const addPackingItem = (catIndex) => { const text = newPackingInputs.value[catIndex]; if(text && text.trim() !== '') { packingList.value[catIndex].items.push({ name: text, checked: false }); newPackingInputs.value[catIndex] = ''; savePackingList(); } };
                const removePackingItem = (catIndex, itemIndex) => { if(confirm('ç¢ºå®šè¦åˆªé™¤æ­¤é …ç›®å—Žï¼Ÿ')) { packingList.value[catIndex].items.splice(itemIndex, 1); savePackingList(); } };

                const openExpenseModal = () => { isEditingExpense.value = false; expenseForm.value = { id: null, category: 'é£²é£Ÿ', name: '', amount: '', paymentType: 'ç¾é‡‘', customName: '', date: tripDays.value[currentDayIndex.value].fullDate }; showExpenseModal.value = true; };
                const editExpense = (exp) => { isEditingExpense.value = true; expenseForm.value = JSON.parse(JSON.stringify(exp)); if (!expenseForm.value.paymentType) { if (expenseForm.value.method === 'ç¾é‡‘') { expenseForm.value.paymentType = 'ç¾é‡‘'; } else { expenseForm.value.paymentType = 'ä¿¡ç”¨å¡'; expenseForm.value.customName = expenseForm.value.method; } } showExpenseModal.value = true; };
                const saveExpense = () => { if(expenseForm.value.name && expenseForm.value.amount) { const newExpense = { ...expenseForm.value, amount: parseInt(expenseForm.value.amount), id: isEditingExpense.value ? expenseForm.value.id : Date.now(), method: expenseForm.value.paymentType === 'ç¾é‡‘' ? 'ç¾é‡‘' : (expenseForm.value.customName || 'ä¿¡ç”¨å¡') }; if(isEditingExpense.value) { const idx = expenses.value.findIndex(e => e.id === newExpense.id); if(idx !== -1) expenses.value[idx] = newExpense; } else { expenses.value.push(newExpense); } saveToStorage(); showExpenseModal.value = false; } };
                const deleteExpense = () => { if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†èŠ±è²»å—Žï¼Ÿ')) { const idx = expenses.value.findIndex(e => e.id === expenseForm.value.id); if(idx !== -1) expenses.value.splice(idx, 1); saveToStorage(); showExpenseModal.value = false; } };

                const saveToStorage = () => {
                    if (!db) return;
                    set(dbRef(db, DB_PATH), {
                        itinerary: itineraryData.value,
                        shopping: shoppingList.value,
                        expenses: expenses.value,
                        packing: packingList.value
                    }).catch((error) => {
                        console.error("Firebase write failed:", error);
                    });
                };

                onMounted(() => {
                    if (!db) return;
                    const tripRef = dbRef(db, DB_PATH);
                    
                    onValue(tripRef, (snapshot) => {
                        isConnected.value = true;
                        const data = snapshot.val();
                        if (data) {
                            if(data.itinerary) itineraryData.value = data.itinerary;
                            if(data.shopping) shoppingList.value = data.shopping;
                            if(data.expenses) expenses.value = data.expenses;
                            if(data.packing) packingList.value = data.packing;
                        } else {
                            // ðŸ’¡ å¦‚æžœè³‡æ–™åº«æ˜¯ç©ºçš„ï¼Œè‡ªå‹•å¯«å…¥æ‚¨æä¾›çš„ã€Œè©³ç´°ç‰ˆè¡Œç¨‹ã€
                            saveToStorage();
                        }
                    }, (error) => {
                        isConnected.value = false;
                        console.error("Read failed:", error);
                    });
                });

                return {
                    isConnected,
                    currentTab, currentDayIndex, tripDays, currentDayItinerary, bannerImage, flightInfos, hotelInfos,
                    showModal, modalForm, openAddModal, closeModal, editItem, saveItem, deleteItem, moveItem, confirmDeleteItem,
                    openMap, openRoute, openDetail, showDetailModal, selectedDetailItem,
                    openActionModal, showActionModal, selectedActionItem, triggerEdit, triggerDelete, 
                    getCategoryIcon, getCategoryColor, getTransitIcon, exchangeRate, calcJpy, calculatedTwd,
                    shoppingList, showShoppingModal, openShoppingModal, shoppingForm, handleImageUpload, addShoppingItem, removeShoppingItem, editShoppingItem, deleteShoppingItem, isEditingShopping,
                    expenses, totalExpenses, cashTotal, cardTotal, cardBreakdown, categoryBreakdown, showExpenseModal, openExpenseModal, 
                    expenseForm, saveExpense, editExpense, deleteExpense, isEditingExpense, getExpenseIcon, getExpenseColor, showStatsModal, usedCards,
                    packingList, savePackingList, resetPackingList, addPackingItem, removePackingItem, newPackingInputs
                };
            }
        }).mount('#app');
    </script>
