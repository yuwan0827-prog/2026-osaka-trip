    <script type="module">
        import { createApp, ref, computed, onMounted, watch } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref as dbRef, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // ðŸŸ¢ æ‚¨çš„ Firebase è¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyA8sysOQedr-G4itsrWzW-i6BfRCLKT_3Q",
            authDomain: "osaka2026-c5974.firebaseapp.com",
            databaseURL: "https://osaka2026-c5974-default-rtdb.firebaseio.com",
            projectId: "osaka2026-c5974",
            storageBucket: "osaka2026-c5974.firebasestorage.app",
            messagingSenderId: "576795484651",
            appId: "1:576795484651:web:72e880993d168436d8b9ae"
        };

        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            console.log("Firebase initialized");
        } catch (e) {
            console.error("Firebase init failed:", e);
        }

        createApp({
            setup() {
                // ðŸ”¹ é€™è£¡ä¿®æ”¹äº†è³‡æ–™åº«è·¯å¾‘åç¨±
                const DB_PATH = 'osaka_trip';

                const isConnected = ref(false);
                const currentTab = ref('itinerary');
                const currentDayIndex = ref(0);
                const showModal = ref(false);
                const showDetailModal = ref(false);
                const showShoppingModal = ref(false);
                const showExpenseModal = ref(false);
                const showStatsModal = ref(false);
                const showActionModal = ref(false);
                const selectedActionItem = ref({});
                const isEditing = ref(false);
                const isEditingExpense = ref(false);
                const isEditingShopping = ref(false); 
                const editingShoppingIndex = ref(null); 
                const bannerImage = ref('https://images.unsplash.com/photo-1590559374747-8c1e09529b5c?q=80&w=1000&auto=format&fit=crop');
                const selectedDetailItem = ref({});

                const exchangeRate = ref(0.22);
                const calcJpy = ref('');
                const calculatedTwd = computed(() => {
                    return calcJpy.value ? Math.round(calcJpy.value * exchangeRate.value).toLocaleString() : '0';
                });

                const defaultPackingList = [
                    { name: 'é‡è¦è­‰ä»¶èˆ‡éŒ¢åŒ…', items: [{ name: 'è­·ç…§ (æª¢æŸ¥æœŸé™)', checked: false }, { name: 'æ—¥å¹£ç¾é‡‘', checked: false }, { name: 'ä¿¡ç”¨å¡ (é–‹å•Ÿæµ·å¤–ææ¬¾)', checked: false }, { name: 'VJW æˆªåœ–', checked: false }] },
                    { name: 'è¡£ç‰©èˆ‡ä¿æš–', items: [{ name: 'ç¾½çµ¨å¤–å¥—', checked: false }, { name: 'ç™¼ç†±è¡£', checked: false }, { name: 'æ¯›å¸½/æ‰‹å¥—', checked: false }, { name: 'å¥½èµ°çš„éž‹', checked: false }] },
                    { name: '3C èˆ‡è—¥å“', items: [{ name: 'æ‰‹æ©Ÿ/å……é›»ç·š', checked: false }, { name: 'è¡Œå‹•é›»æº (å¿…å‚™)', checked: false }, { name: 'ç¶²å¡é‡', checked: false }, { name: 'å¸¸å‚™è—¥/OKç¹ƒ', checked: false }] }
                ];
                const packingList = ref(JSON.parse(JSON.stringify(defaultPackingList)));
                const newPackingInputs = ref({}); 

                const tripDays = ref([
                    { date: '2/4', weekday: 'Wed', fullDate: '2026-02-04', location: 'å¤§é˜ª/æ¢…ç”°', weather: { temp: 8, feels: 5, icon: 'fa-solid fa-cloud', desc: 'å¤šé›²æ™‚é™°' }, mustBring: 'è­·ç…§ã€VJW æˆªåœ–ã€å¤§è¡ŒæŽç®±(ç©ºä¸€åŠ)ã€è¡Œå‹•é›»æºã€‚' },
                    { date: '2/5', weekday: 'Thu', fullDate: '2026-02-05', location: 'å¤§é˜ª/USJ', weather: { temp: 6, feels: 2, icon: 'fa-solid fa-sun', desc: 'æ™´æ™‚å¤šé›²' }, mustBring: 'USJ APP (å…ˆä¸‹è¼‰)ã€å…©é¡†æ»¿é›»çš„è¡Œå‹•é›»æº (çŽ©é¦¬åŠ›æ­æœƒè€—é›»)ã€æš–æš–åŒ… (æµ·é‚Šé¢¨å¤§)ã€å¸½å­æ‰‹å¥—ã€‚' },
                    { date: '2/6', weekday: 'Fri', fullDate: '2026-02-06', location: 'æœ‰é¦¬æº«æ³‰', weather: { temp: 4, feels: 0, icon: 'fa-regular fa-snowflake', desc: 'å¯èƒ½ä¸‹é›ª' }, mustBring: 'è¼•ä¾¿éŽå¤œåŒ… (æ›æ´—è¡£ç‰©)ã€å„ç¨®å……é›»ç·šã€‚å¤§è¡ŒæŽè¨˜å¾—æ—©ä¸Šå¯„å‡ºï¼' },
                    { date: '2/7', weekday: 'Sat', fullDate: '2026-02-07', location: 'äº¬éƒ½', weather: { temp: 5, feels: 2, icon: 'fa-solid fa-cloud-sun', desc: 'å¤šé›²' }, mustBring: 'ç©ºçš„èƒƒ (åƒéŒ¦å¸‚å ´)ã€å¥½èµ°çš„éž‹ã€‚' },
                    { date: '2/8', weekday: 'Sun', fullDate: '2026-02-08', location: 'äº¬éƒ½', weather: { temp: 7, feels: 4, icon: 'fa-solid fa-sun', desc: 'æ™´æœ—' }, mustBring: 'é˜²æ»‘çš„éž‹ (çŒ´å­å…¬åœ’æ˜¯æ³¥åœŸè·¯)ã€é›¶éŒ¢ (è²·é£¼æ–™é¤µçŒ´å­)ã€‚' },
                    { date: '2/9', weekday: 'Mon', fullDate: '2026-02-09', location: 'é—œè¥¿æ©Ÿå ´', weather: { temp: 9, feels: 6, icon: 'fa-solid fa-cloud', desc: 'å¤šé›²' }, mustBring: 'è­·ç…§ (æ”¾åœ¨å¥½æ‹¿çš„åœ°æ–¹)ã€å‰©é¤˜çš„æ—¥å¹£é›¶éŒ¢ (è½‰æ‰­è›‹)ã€‚' },
                ]);

                const itineraryData = ref({ 0:[], 1:[], 2:[], 3:[], 4:[], 5:[] });

                const flightInfos = [
                    { type: 'åŽ»ç¨‹', date: '2026/2/4', dep: 'TPE', arr: 'KIX', depTime: '13:20', arrTime: '16:50', duration: '2h35m', code: 'CI152', terminal: 'æ¡ƒæ©Ÿ T2 / é—œè¥¿ T1' },
                    { type: 'å›žç¨‹', date: '2026/2/9', dep: 'KIX', arr: 'TPE', depTime: '14:00', arrTime: '16:15', duration: '3h15m', code: 'JX823', terminal: 'é—œè¥¿ T1 / æ¡ƒæ©Ÿ T1' }
                ];
                
                const hotelInfos = [
                    { name: 'Hotel Vischio Osaka', engName: 'by Granvia', address: 'å¤§é˜ªåºœå¤§é˜ªå¸‚åŒ—å€èŠç”°2ä¸ç›®4-10', booker: 'Lai You Wen', platform: 'Agoda' },
                    { name: 'æœ‰é¦¬å…µè¡›å‘é™½é–£', engName: 'Arima Onsen Hyoe Koyokaku', address: 'å…µåº«çœŒç¥žæˆ¸å¸‚åŒ—åŒºæœ‰é¦¬ç”º1904', booker: 'Li Gen Liang', platform: 'å®˜ç¶²' },
                    { name: 'Daiwa Roynet Hotel', engName: 'Kyoto Terrace Hachijo PREMIER', address: 'äº¬éƒ½å¸‚å—åŒºæ±ä¹æ¡æ±å±±çŽ‹ç”º14-1', booker: 'Lai You Wen', platform: 'Trip' }
                ];

                const modalForm = ref({});
                const shoppingList = ref([]);
                const shoppingForm = ref({ name: '', image: null });
                const expenses = ref([]);
                const expenseForm = ref({ id: null, category: 'é£²é£Ÿ', name: '', amount: '', paymentType: 'ç¾é‡‘', customName: '', date: '' });

                const currentDayItinerary = computed(() => itineraryData.value[currentDayIndex.value] || []);
                const totalExpenses = computed(() => expenses.value.reduce((sum, item) => sum + item.amount, 0));
                const cashTotal = computed(() => expenses.value.filter(i => i.method === 'ç¾é‡‘' || i.paymentType === 'ç¾é‡‘').reduce((sum, item) => sum + item.amount, 0));
                const cardTotal = computed(() => expenses.value.filter(i => (i.method !== 'ç¾é‡‘' && i.paymentType !== 'ç¾é‡‘')).reduce((sum, item) => sum + item.amount, 0));
                
                const cardBreakdown = computed(() => {
                    const breakdown = {};
                    expenses.value.forEach(item => {
                        let key = item.method;
                        if (item.paymentType) { if (item.paymentType === 'ç¾é‡‘') key = 'ç¾é‡‘'; else key = item.customName || 'ä¿¡ç”¨å¡'; }
                        breakdown[key] = (breakdown[key] || 0) + item.amount;
                    });
                    return breakdown;
                });
                
                const usedCards = computed(() => {
                    const cards = new Set();
                    expenses.value.forEach(item => {
                        if(item.paymentType === 'ä¿¡ç”¨å¡' && item.customName) cards.add(item.customName);
                        if(item.method !== 'ç¾é‡‘' && item.method !== 'ä¿¡ç”¨å¡' && item.method) cards.add(item.method);
                    });
                    return Array.from(cards);
                });
                
                const categoryBreakdown = computed(() => {
                    const breakdown = {};
                    expenses.value.forEach(item => { breakdown[item.category] = (breakdown[item.category] || 0) + item.amount; });
                    return breakdown;
                });

                const getCategoryIcon = (cat) => { const map = { sight: 'fa-camera', food: 'fa-utensils', shop: 'fa-bag-shopping', hotel: 'fa-bed', traffic: 'fa-train-subway', flight: 'fa-plane', other: 'fa-circle' }; return `fa-solid ${map[cat] || 'fa-circle'}`; };
                const getCategoryColor = (cat) => { const map = { sight: 'bg-orange-400', food: 'bg-red-400', shop: 'bg-purple-400', hotel: 'bg-blue-400', traffic: 'bg-gray-400', flight: 'bg-sky-500', other: 'bg-slate-400' }; return map[cat] || 'bg-slate-400'; };
                const getTransitIcon = (type) => { if(type === 'walk') return 'fa-solid fa-person-walking'; if(type === 'car') return 'fa-solid fa-bus'; if(type === 'hotel') return 'fa-solid fa-bed'; return 'fa-solid fa-train-subway'; };
                const getExpenseIcon = (cat) => { const map = { 'é£²é£Ÿ': 'fa-utensils', 'äº¤é€š': 'fa-train', 'è³¼ç‰©': 'fa-bag-shopping', 'é–€ç¥¨': 'fa-ticket', 'ä½å®¿': 'fa-bed', 'å…¶ä»–': 'fa-circle' }; return `fa-solid ${map[cat] || 'fa-circle'}`; };
                const getExpenseColor = (cat) => { const map = { 'é£²é£Ÿ': 'bg-red-400', 'äº¤é€š': 'bg-gray-400', 'è³¼ç‰©': 'bg-purple-400', 'é–€ç¥¨': 'bg-orange-400', 'ä½å®¿': 'bg-blue-400', 'å…¶ä»–': 'bg-slate-400' }; return map[cat] || 'bg-slate-400'; };

                const cleanName = (name) => {
                    return name.replace(/Check-in:\s*/i, '').replace(/^å‰å¾€/, '').replace(/ã€.*?ã€‘/g, '').replace(/ï¼ˆ.*?ï¼‰/g, '').trim();
                };

                const openMap = (keyword) => {
                    const url = 'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(cleanName(keyword));
                    window.open(url, '_blank');
                };

                const openRoute = (index) => {
                    const list = currentDayItinerary.value;
                    const destination = cleanName(list[index].name);
                    let origin = '';
                    let mode = 'transit'; 
                    const type = list[index].transit?.type || 'train';
                    if (type === 'car') mode = 'driving'; else if (type === 'walk') mode = 'walking';
                    
                    if (index > 0) { 
                        const prevItem = list[index - 1]; 
                        if (prevItem.type === 'flight') origin = 'Kansai International Airport'; 
                        else origin = cleanName(prevItem.name); 
                    } else { 
                        const hotels = ['', 'Hotel Vischio Osaka', 'Hotel Vischio Osaka', 'Arima Onsen Hyoe Koyokaku', 'Daiwa Roynet Hotel Kyoto Terrace Hachijo', 'Daiwa Roynet Hotel Kyoto Terrace Hachijo' ]; 
                        origin = hotels[currentDayIndex.value] || 'Current Location'; 
                    }
                    const url = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}&travelmode=${mode}`;
                    window.open(url, '_blank');
                };

                const openDetail = (item) => { selectedDetailItem.value = item; showDetailModal.value = true; };
                
                const openAddModal = () => { isEditing.value = false; modalForm.value = { category: 'sight', transitType: 'walk', startTime: '10:00', name: '', note: '', businessHours: '', ticket: '' }; showModal.value = true; };
                
                const closeModal = () => { showModal.value = false; };
                const openActionModal = (item) => { selectedActionItem.value = item; showActionModal.value = true; };
                const triggerEdit = () => { showActionModal.value = false; editItem(selectedActionItem.value); };
                const triggerDelete = () => { showActionModal.value = false; confirmDeleteItem(selectedActionItem.value); };
                const editItem = (item) => { isEditing.value = true; modalForm.value = JSON.parse(JSON.stringify(item)); modalForm.value.startTime = item.time; modalForm.value.transitType = item.transit ? item.transit.type : 'train'; showModal.value = true; };
                const confirmDeleteItem = (item) => { if(confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${item.name}ã€å—Žï¼Ÿåˆªé™¤å¾Œç„¡æ³•å¾©åŽŸã€‚`)) { const dayList = itineraryData.value[currentDayIndex.value]; const idx = dayList.findIndex(i => i.id === item.id); if(idx !== -1) dayList.splice(idx, 1); saveToStorage(); } };

                const saveItem = () => { 
                    const dayList = itineraryData.value[currentDayIndex.value]; 
                    const newItem = { 
                        id: isEditing.value ? modalForm.value.id : Date.now(), 
                        type: modalForm.value.category === 'flight' ? 'flight' : 'normal', 
                        category: modalForm.value.category, 
                        name: modalForm.value.name || 'æœªå‘½åè¡Œç¨‹', 
                        time: modalForm.value.startTime || '00:00',
                        businessHours: modalForm.value.businessHours || '', 
                        ticket: modalForm.value.ticket || '', 
                        note: modalForm.value.note || '', 
                        tags: dayList.find(i => i.id === modalForm.value.id)?.tags || [],
                        desc: dayList.find(i => i.id === modalForm.value.id)?.desc || '',
                        mustEat: dayList.find(i => i.id === modalForm.value.id)?.mustEat || '',
                        mustBuy: dayList.find(i => i.id === modalForm.value.id)?.mustBuy || '',
                        photoTip: dayList.find(i => i.id === modalForm.value.id)?.photoTip || '',
                        transit: isEditing.value && dayList.find(i => i.id === modalForm.value.id)?.transit ? { ...dayList.find(i => i.id === modalForm.value.id).transit, type: modalForm.value.transitType } : (currentDayIndex.value === 0 && dayList.length === 0 ? null : { type: modalForm.value.transitType }), 
                        flightInfo: modalForm.value.category === 'flight' ? { depCode: 'XXX', arrCode: 'XXX', number: 'FLIGHT' } : null 
                    }; 
                    
                    if (isEditing.value) { const idx = dayList.findIndex(i => i.id === newItem.id); dayList[idx] = newItem; } else { dayList.push(newItem); } 
                    dayList.sort((a, b) => a.time.localeCompare(b.time)); 
                    saveToStorage(); 
                    showModal.value = false; 
                };
                
                const deleteItem = () => { confirmDeleteItem(modalForm.value); showModal.value = false; };
                const moveItem = (index, direction) => { const list = itineraryData.value[currentDayIndex.value]; const targetIndex = index + direction; if (targetIndex >= 0 && targetIndex < list.length) { [list[index], list[targetIndex]] = [list[targetIndex], list[index]]; saveToStorage(); } };
                
                const openShoppingModal = () => { isEditingShopping.value = false; shoppingForm.value = { name: '', image: null }; showShoppingModal.value = true; };
                const editShoppingItem = (item, idx) => { isEditingShopping.value = true; editingShoppingIndex.value = idx; shoppingForm.value = { ...item }; showShoppingModal.value = true; };
                const handleImageUpload = (e) => { const file = e.target.files[0]; if(file) { const reader = new FileReader(); reader.onload = (e) => shoppingForm.value.image = e.target.result; reader.readAsDataURL(file); } };
                const addShoppingItem = () => { if(shoppingForm.value.name) { if(isEditingShopping.value) { shoppingList.value[editingShoppingIndex.value] = { ...shoppingForm.value }; } else { shoppingList.value.push({ ...shoppingForm.value }); } saveToStorage(); showShoppingModal.value = false; } };
                const removeShoppingItem = (idx) => { if(confirm('åˆªé™¤æ­¤å•†å“ï¼Ÿ')) { shoppingList.value.splice(idx, 1); saveToStorage(); } };
                const deleteShoppingItem = () => { if(confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å•†å“ï¼Ÿ')) { shoppingList.value.splice(editingShoppingIndex.value, 1); saveToStorage(); showShoppingModal.value = false; } };

                const savePackingList = () => { saveToStorage(); };
                const resetPackingList = () => { if(confirm('ç¢ºå®šè¦é‡ç½®ç‚ºé è¨­æ¸…å–®å—Žï¼Ÿ')) { packingList.value = JSON.parse(JSON.stringify(defaultPackingList)); savePackingList(); } };
                const addPackingItem = (catIndex) => { const text = newPackingInputs.value[catIndex]; if(text && text.trim() !== '') { packingList.value[catIndex].items.push({ name: text, checked: false }); newPackingInputs.value[catIndex] = ''; savePackingList(); } };
                const removePackingItem = (catIndex, itemIndex) => { if(confirm('ç¢ºå®šè¦åˆªé™¤æ­¤é …ç›®å—Žï¼Ÿ')) { packingList.value[catIndex].items.splice(itemIndex, 1); savePackingList(); } };

                const openExpenseModal = () => { isEditingExpense.value = false; expenseForm.value = { id: null, category: 'é£²é£Ÿ', name: '', amount: '', paymentType: 'ç¾é‡‘', customName: '', date: tripDays.value[currentDayIndex.value].fullDate }; showExpenseModal.value = true; };
                const editExpense = (exp) => { isEditingExpense.value = true; expenseForm.value = JSON.parse(JSON.stringify(exp)); if (!expenseForm.value.paymentType) { if (expenseForm.value.method === 'ç¾é‡‘') { expenseForm.value.paymentType = 'ç¾é‡‘'; } else { expenseForm.value.paymentType = 'ä¿¡ç”¨å¡'; expenseForm.value.customName = expenseForm.value.method; } } showExpenseModal.value = true; };
                const saveExpense = () => { if(expenseForm.value.name && expenseForm.value.amount) { const newExpense = { ...expenseForm.value, amount: parseInt(expenseForm.value.amount), id: isEditingExpense.value ? expenseForm.value.id : Date.now(), method: expenseForm.value.paymentType === 'ç¾é‡‘' ? 'ç¾é‡‘' : (expenseForm.value.customName || 'ä¿¡ç”¨å¡') }; if(isEditingExpense.value) { const idx = expenses.value.findIndex(e => e.id === newExpense.id); if(idx !== -1) expenses.value[idx] = newExpense; } else { expenses.value.push(newExpense); } saveToStorage(); showExpenseModal.value = false; } };
                const deleteExpense = () => { if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†èŠ±è²»å—Žï¼Ÿ')) { const idx = expenses.value.findIndex(e => e.id === expenseForm.value.id); if(idx !== -1) expenses.value.splice(idx, 1); saveToStorage(); showExpenseModal.value = false; } };

                const saveToStorage = () => {
                    if (!db) return;
                    set(dbRef(db, DB_PATH), {
                        itinerary: itineraryData.value,
                        shopping: shoppingList.value,
                        expenses: expenses.value,
                        packing: packingList.value
                    }).catch((error) => {
                        console.error("Firebase write failed:", error);
                    });
                };

                onMounted(() => {
                    if (!db) return;
                    const tripRef = dbRef(db, DB_PATH);
                    
                    onValue(tripRef, (snapshot) => {
                        isConnected.value = true;
                        const data = snapshot.val();
                        if (data) {
                            if(data.itinerary) itineraryData.value = data.itinerary;
                            if(data.shopping) shoppingList.value = data.shopping;
                            if(data.expenses) expenses.value = data.expenses;
                            if(data.packing) packingList.value = data.packing;
                        }
                    }, (error) => {
                        isConnected.value = false;
                        console.error("Read failed:", error);
                    });
                });

                return {
                    isConnected,
                    currentTab, currentDayIndex, tripDays, currentDayItinerary, bannerImage, flightInfos, hotelInfos,
                    showModal, modalForm, openAddModal, closeModal, editItem, saveItem, deleteItem, moveItem, confirmDeleteItem,
                    openMap, openRoute, openDetail, showDetailModal, selectedDetailItem,
                    openActionModal, showActionModal, selectedActionItem, triggerEdit, triggerDelete, 
                    getCategoryIcon, getCategoryColor, getTransitIcon, exchangeRate, calcJpy, calculatedTwd,
                    shoppingList, showShoppingModal, openShoppingModal, shoppingForm, handleImageUpload, addShoppingItem, removeShoppingItem, editShoppingItem, deleteShoppingItem, isEditingShopping,
                    expenses, totalExpenses, cashTotal, cardTotal, cardBreakdown, categoryBreakdown, showExpenseModal, openExpenseModal, 
                    expenseForm, saveExpense, editExpense, deleteExpense, isEditingExpense, getExpenseIcon, getExpenseColor, showStatsModal, usedCards,
                    packingList, savePackingList, resetPackingList, addPackingItem, removePackingItem, newPackingInputs
                };
            }
        }).mount('#app');
    </script>
