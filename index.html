<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 å¤§é˜ªäº¬éƒ½è¦ªå­ç©¶æ¥µä¹‹æ—… (å°éŠå‡ç´šç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #F0F4F8;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            user-select: none;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .boarding-pass {
            background: linear-gradient(135deg, #fff 0%, #f3f4f6 100%);
            border-left: 4px solid #3B82F6;
        }
        .soft-shadow {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }
        .active-scale:active {
            transform: scale(0.98);
        }
        @keyframes loadBar {
            from { width: 0; }
        }
        .animate-bar {
            animation: loadBar 1s ease-out forwards;
        }
        .highlight-tag {
            background-color: #FEF3C7;
            color: #92400E;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-right: 4px;
        }
    </style>
</head>
<body class="text-slate-700">

    <div id="app" class="max-w-md mx-auto bg-[#F5F7FA] min-h-screen relative shadow-2xl overflow-hidden sm:max-w-full md:max-w-[480px]">
        
        <header class="relative w-full h-[250px] z-10">
            <div class="absolute inset-0 w-full h-full overflow-hidden rounded-b-[3rem] shadow-lg">
                <img :src="bannerImage" alt="Osaka Winter" class="w-full h-full object-cover brightness-90">
                <div class="absolute inset-0 bg-gradient-to-t from-blue-900/60 to-transparent"></div>
            </div>
            
            <div class="absolute top-6 left-6 text-white drop-shadow-md">
                <h1 class="text-2xl font-bold tracking-widest">OSAKA 2026</h1>
                <p class="text-sm opacity-90">Ultimate Family Trip</p>
            </div>

            <div class="absolute bottom-4 right-6 flex gap-3 z-20">
                <button @click="currentTab = 'itinerary'" :class="['w-10 h-10 rounded-full flex items-center justify-center transition-all shadow-lg backdrop-blur-md', currentTab === 'itinerary' ? 'bg-white text-blue-600 scale-110' : 'bg-white/30 text-white hover:bg-white/50']">
                    <i class="fa-solid fa-location-dot"></i>
                </button>
                <button @click="currentTab = 'info'" :class="['w-10 h-10 rounded-full flex items-center justify-center transition-all shadow-lg backdrop-blur-md', currentTab === 'info' ? 'bg-white text-blue-600 scale-110' : 'bg-white/30 text-white hover:bg-white/50']">
                    <i class="fa-solid fa-circle-info"></i>
                </button>
                <button @click="currentTab = 'shopping'" :class="['w-10 h-10 rounded-full flex items-center justify-center transition-all shadow-lg backdrop-blur-md', currentTab === 'shopping' ? 'bg-white text-blue-600 scale-110' : 'bg-white/30 text-white hover:bg-white/50']">
                    <i class="fa-solid fa-basket-shopping"></i>
                </button>
                <button @click="currentTab = 'expenses'" :class="['w-10 h-10 rounded-full flex items-center justify-center transition-all shadow-lg backdrop-blur-md', currentTab === 'expenses' ? 'bg-white text-blue-600 scale-110' : 'bg-white/30 text-white hover:bg-white/50']">
                    <i class="fa-solid fa-yen-sign"></i>
                </button>
            </div>
        </header>

        <main class="relative z-0 -mt-8 pt-10 pb-24 px-4 min-h-[calc(100vh-250px)]">
            
            <div v-if="currentTab === 'itinerary'" class="animate-fade-in">
                <div class="flex overflow-x-auto no-scrollbar gap-3 mb-4 pb-2">
                    <div v-for="(day, index) in tripDays" :key="index" @click="currentDayIndex = index" :class="['flex-shrink-0 flex flex-col items-center justify-center w-14 h-16 rounded-2xl transition-all cursor-pointer border active-scale', currentDayIndex === index ? 'bg-blue-600 text-white border-blue-600 shadow-lg shadow-blue-200' : 'bg-white text-gray-400 border-transparent']">
                        <span class="text-xs font-bold uppercase">{{ day.weekday }}</span><span class="text-xl font-bold">{{ day.date }}</span>
                    </div>
                </div>

                <div class="bg-white rounded-2xl p-4 shadow-lg mb-6 border-l-4 border-blue-500">
                    <div class="flex items-center justify-between mb-3 border-b border-gray-100 pb-2">
                        <div class="flex items-center gap-2">
                            <i :class="[tripDays[currentDayIndex].weather.icon, 'text-blue-500 text-xl']"></i>
                            <div>
                                <span class="text-sm font-bold text-slate-700">{{ tripDays[currentDayIndex].location }}</span>
                                <span class="text-xs text-gray-400 ml-2">{{ tripDays[currentDayIndex].weather.desc }} {{ tripDays[currentDayIndex].weather.temp }}Â°C</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-start gap-2">
                        <div class="bg-red-100 text-red-600 text-[10px] font-bold px-2 py-1 rounded shrink-0">ğŸ’ ä»Šæ—¥å¿…å¸¶</div>
                        <div class="text-xs text-slate-600 leading-relaxed font-medium">{{ tripDays[currentDayIndex].mustBring }}</div>
                    </div>
                </div>

                <div class="space-y-4">
                    <div v-for="(item, index) in currentDayItinerary" :key="item.id" class="relative group">
                        
                        <div v-if="item.transit" 
                             @click="openRoute(index)"
                             class="flex items-center justify-center py-2 text-xs text-blue-400 hover:text-blue-600 gap-2 cursor-pointer transition-colors active:scale-95">
                            <span class="h-6 w-[1px] bg-blue-200"></span>
                            <div class="flex items-center gap-1 bg-blue-50 px-3 py-1 rounded-full border border-blue-100 shadow-sm">
                                <i :class="getTransitIcon(item.transit.type)"></i>
                                <span class="font-bold">{{ item.transit.duration || 'ğŸ“ æŸ¥çœ‹è·¯ç·š' }}</span>
                                <i class="fa-solid fa-chevron-right text-[10px] ml-1 opacity-50"></i>
                            </div>
                            <span class="h-6 w-[1px] bg-blue-200"></span>
                        </div>

                        <div 
                            @click="openActionModal(item)"
                            :class="['relative z-10 bg-white p-4 border border-slate-100 rounded-2xl soft-shadow transition-transform duration-300 ease-out pr-12 cursor-pointer active:scale-[0.99]', 
                                     item.type === 'flight' ? 'boarding-pass' : '']"
                        >
                            <div class="absolute right-0 top-0 bottom-0 flex flex-col justify-center items-center gap-2 px-2 bg-gray-50/50 border-l border-gray-100 rounded-r-2xl" @click.stop>
                                <button v-if="index > 0" @click="moveItem(index, -1)" class="w-8 h-8 text-gray-400 hover:text-blue-500 active:text-blue-600 rounded-full flex items-center justify-center"><i class="fa-solid fa-chevron-up"></i></button>
                                <button v-if="index < currentDayItinerary.length - 1" @click="moveItem(index, 1)" class="w-8 h-8 text-gray-400 hover:text-blue-500 active:text-blue-600 rounded-full flex items-center justify-center"><i class="fa-solid fa-chevron-down"></i></button>
                            </div>

                            <div v-if="item.type === 'flight'" class="flex flex-col gap-3 mb-2 mr-4">
                                <div class="flex justify-between items-center border-b border-dashed border-slate-300 pb-2"><div class="text-2xl font-black text-blue-800">{{ item.flightInfo.depCode }}</div><i class="fa-solid fa-plane text-blue-400"></i><div class="text-2xl font-black text-blue-800">{{ item.flightInfo.arrCode }}</div></div>
                                <div class="flex justify-between text-sm"><div><div class="text-xs text-gray-500">èµ·é£›</div><div class="font-bold">{{ item.time }}</div></div><div class="text-right"><div class="text-xs text-gray-500">èˆªç­</div><div class="font-bold">{{ item.flightInfo.number }}</div></div></div>
                                <div class="bg-blue-50 text-blue-600 text-xs p-2 rounded mt-1"><i class="fa-solid fa-circle-info mr-1"></i> {{ item.note }}</div>
                            </div>
                            <div v-else class="flex gap-4 mb-2 mr-2">
                                <div class="flex flex-col items-center min-w-[3rem]"><span class="text-sm font-bold text-slate-700">{{ item.time.split(' ')[0] }}</span><div :class="['w-8 h-8 rounded-full flex items-center justify-center text-white mt-1 text-xs', getCategoryColor(item.category)]"><i :class="getCategoryIcon(item.category)"></i></div></div>
                                <div class="flex-1">
                                    <h3 class="font-bold text-slate-800 text-lg leading-tight mb-1">{{ item.name }}</h3>
                                    <div v-if="item.tags" class="flex flex-wrap gap-1 mb-1">
                                        <span v-for="tag in item.tags" class="highlight-tag">{{ tag }}</span>
                                    </div>
                                    <div v-if="item.businessHours" class="text-xs text-gray-500 mb-1"><i class="fa-regular fa-clock mr-1"></i> {{ item.businessHours }}</div>
                                    <div v-if="item.ticket" class="text-xs text-orange-500 mb-1 font-medium"><i class="fa-solid fa-ticket mr-1"></i> {{ item.ticket }}</div>
                                </div>
                            </div>
                            
                            <div class="flex border-t border-gray-100 mt-2 pt-2 gap-2">
                                <button @click.stop="openMap(item.name)" class="flex-1 flex items-center justify-center gap-1 py-2 text-sm text-blue-600 font-bold bg-blue-50 rounded-xl active:scale-95 transition-transform"><i class="fa-solid fa-location-dot"></i> å°èˆª</button>
                                <button @click.stop="openDetail(item)" class="flex-1 flex items-center justify-center gap-1 py-2 text-sm text-orange-600 font-bold bg-orange-50 rounded-xl active:scale-95 transition-transform"><i class="fa-solid fa-book-open"></i> æ”»ç•¥</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="h-20 flex items-center justify-center text-xs text-gray-400"><i class="fa-solid fa-hand-pointer mr-1"></i> é»æ“Šè¡Œç¨‹å¡ç‰‡å¯ç·¨è¼¯æˆ–åˆªé™¤</div>
                <button @click="openAddModal" class="fixed bottom-24 right-6 w-14 h-14 bg-blue-600 text-white rounded-full shadow-xl flex items-center justify-center text-2xl hover:scale-110 active:scale-95 transition-transform z-30"><i class="fa-solid fa-plus"></i></button>
            </div>

            <div v-if="currentTab === 'info'" class="space-y-6 animate-fade-in pb-20">
                <section class="bg-white rounded-2xl p-5 soft-shadow"><h3 class="font-bold text-blue-900 mb-4 flex items-center justify-between"><span><i class="fa-solid fa-suitcase-rolling mr-2"></i> è¡Œææ‰“åŒ…æ¸…å–®</span><button @click="resetPackingList" class="text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded">é‡ç½®é è¨­</button></h3><div class="space-y-5"><div v-for="(category, catIndex) in packingList" :key="catIndex"><h4 class="text-sm font-bold text-slate-500 mb-2 pl-1 border-l-4 border-blue-200">{{ category.name }}</h4><div class="grid grid-cols-1 gap-2"><div v-for="(item, itemIndex) in category.items" :key="itemIndex" class="flex items-center gap-2 p-2 bg-gray-50 rounded-xl active:bg-gray-100"><label class="flex items-center gap-2 flex-1 cursor-pointer select-none"><input type="checkbox" v-model="item.checked" @change="savePackingList" class="hidden custom-checkbox"><div class="w-5 h-5 border-2 border-gray-300 rounded-full flex items-center justify-center bg-white transition-colors shrink-0"><svg class="w-3 h-3 text-white hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg></div><span :class="['text-sm transition-all', item.checked ? 'text-gray-400 line-through' : 'text-slate-700']">{{ item.name }}</span></label><button @click="removePackingItem(catIndex, itemIndex)" class="text-gray-300 hover:text-red-500 px-2"><i class="fa-solid fa-trash-can text-sm"></i></button></div><div class="flex gap-2 mt-1"><input v-model="newPackingInputs[catIndex]" @keyup.enter="addPackingItem(catIndex)" class="flex-1 bg-white border border-dashed border-gray-300 rounded-lg px-2 py-1 text-sm focus:outline-none focus:border-blue-300" placeholder="æ–°å¢é …ç›®..."><button @click="addPackingItem(catIndex)" class="bg-blue-50 text-blue-500 px-3 rounded-lg text-sm hover:bg-blue-100"><i class="fa-solid fa-plus"></i></button></div></div></div></div></section>
                <section class="bg-white rounded-2xl p-5 soft-shadow"><h3 class="font-bold text-blue-900 mb-4 flex items-center"><i class="fa-solid fa-coins mr-2"></i> åŒ¯ç‡æ›ç®—</h3><div class="flex items-center gap-3 bg-gray-50 p-3 rounded-xl border border-gray-100"><div class="flex-1"><label class="text-xs text-gray-500 block mb-1">æ—¥å¹£ (JPY)</label><input type="number" v-model="calcJpy" class="w-full bg-transparent text-xl font-bold outline-none" placeholder="0"></div><i class="fa-solid fa-arrow-right-arrow-left text-gray-300"></i><div class="flex-1 text-right"><label class="text-xs text-gray-500 block mb-1">å°å¹£ (TWD)</label><div class="text-xl font-bold text-blue-600">{{ calculatedTwd }}</div></div></div><p class="text-xs text-gray-400 mt-2 text-right">åŒ¯ç‡è¨­å®š: {{ exchangeRate }}</p></section>
                <section><h3 class="font-bold text-slate-700 mb-3 ml-1">ä½å®¿è³‡è¨Š</h3><div class="space-y-3"><div v-for="hotel in hotelInfos" :key="hotel.name" class="bg-white rounded-2xl p-4 soft-shadow"><h4 class="font-bold text-blue-900">{{ hotel.name }}</h4><p class="text-xs text-gray-500 mt-1 mb-2">{{ hotel.engName }}</p><div class="flex flex-col gap-2 text-sm text-gray-600"><div class="flex items-start gap-2"><i class="fa-solid fa-map-pin mt-1 text-red-400"></i><a :href="'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(hotel.address)" target="_blank" class="underline decoration-gray-300">{{ hotel.address }}</a></div><div class="flex items-center gap-2"><i class="fa-solid fa-user text-blue-400"></i><span>{{ hotel.booker }} ({{ hotel.platform }})</span></div></div></div></div></section>
            </div>

            <div v-if="currentTab === 'shopping'" class="animate-fade-in pb-20"><div class="grid grid-cols-2 gap-4"><div v-for="(item, idx) in shoppingList" :key="idx" @click="editShoppingItem(item, idx)" class="bg-white rounded-2xl p-3 soft-shadow flex flex-col relative group active:scale-95 transition-transform cursor-pointer"><div class="aspect-square bg-gray-100 rounded-xl mb-2 overflow-hidden flex items-center justify-center relative"><img v-if="item.image" :src="item.image" class="w-full h-full object-cover"><i v-else class="fa-solid fa-image text-gray-300 text-2xl"></i><div class="absolute bottom-1 right-1 bg-black/50 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs"><i class="fa-solid fa-pen"></i></div></div><h4 class="font-bold text-sm text-slate-700 truncate">{{ item.name }}</h4></div><div @click="openShoppingModal" class="bg-white/50 border-2 border-dashed border-blue-200 rounded-2xl flex flex-col items-center justify-center aspect-square cursor-pointer text-blue-300 hover:bg-blue-50 active-scale"><i class="fa-solid fa-plus text-3xl mb-2"></i><span class="text-xs font-bold">æ–°å¢å•†å“</span></div></div></div>
            <div v-if="currentTab === 'expenses'" class="animate-fade-in pb-20 relative"><div class="flex justify-end mb-4"><button @click="showStatsModal = true" class="bg-white text-blue-600 border border-blue-100 px-4 py-2 rounded-xl text-sm font-bold shadow-sm active-scale flex items-center gap-2"><i class="fa-solid fa-chart-pie text-blue-500"></i> çµ±è¨ˆå ±è¡¨</button></div><div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-5 text-white shadow-xl mb-6"><div class="text-sm opacity-60 mb-1">ç¸½èŠ±è²» (JPY)</div><div class="text-4xl font-bold mb-4">Â¥ {{ totalExpenses.toLocaleString() }}</div><div class="grid grid-cols-2 gap-4 border-t border-white/10 pt-4"><div><div class="text-xs opacity-60">ç¾é‡‘æ”¯ä»˜</div><div class="font-bold text-lg">Â¥ {{ cashTotal.toLocaleString() }}</div></div><div><div class="text-xs opacity-60">ä¿¡ç”¨å¡æ”¯ä»˜</div><div class="font-bold text-lg">Â¥ {{ cardTotal.toLocaleString() }}</div></div></div></div><div class="bg-white rounded-2xl soft-shadow overflow-hidden"><div v-for="(exp, idx) in expenses" :key="exp.id" @click="editExpense(exp)" class="p-4 border-b border-gray-50 flex justify-between items-center last:border-0 active:bg-gray-50 cursor-pointer"><div class="flex items-center gap-3"><div :class="['w-10 h-10 rounded-full flex items-center justify-center text-white shrink-0', getExpenseColor(exp.category)]"><i :class="getExpenseIcon(exp.category)"></i></div><div><div class="font-bold text-slate-700">{{ exp.name }}</div><div class="text-xs text-gray-400">{{ exp.date }} Â· {{ exp.category }}</div></div></div><div class="text-right"><div class="font-bold text-slate-800">Â¥{{ exp.amount.toLocaleString() }}</div><div class="text-xs text-gray-400"><span v-if="exp.method === 'ç¾é‡‘'" class="text-green-500 font-bold">ç¾é‡‘</span><span v-else class="text-blue-500 font-bold"><i class="fa-regular fa-credit-card mr-1"></i>{{ exp.customName || exp.method }}</span></div></div></div><div v-if="expenses.length === 0" class="p-8 text-center text-gray-400 text-sm">é‚„æ²’æœ‰è¨˜å¸³ç´€éŒ„ï¼ŒæŒ‰å³ä¸‹è§’æ–°å¢ï¼</div></div><button @click="openExpenseModal" class="fixed bottom-24 right-6 w-14 h-14 bg-emerald-500 text-white rounded-full shadow-xl flex items-center justify-center text-2xl hover:scale-110 active:scale-95 transition-transform z-30"><i class="fa-solid fa-plus"></i></button></div>
        </main>

        <div v-if="showActionModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm" @click.self="showActionModal = false">
            <div class="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl transform transition-all scale-100 text-center animate-slide-up">
                <h3 class="text-lg font-bold mb-1 text-slate-800">è¡Œç¨‹ç®¡ç†</h3>
                <p class="text-sm text-gray-500 mb-6 truncate">{{ selectedActionItem.name }}</p>
                <div class="space-y-3">
                    <button @click="triggerEdit" class="w-full bg-slate-100 text-slate-700 py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-slate-200 transition-colors"><i class="fa-solid fa-pen"></i> ä¿®æ”¹è¡Œç¨‹</button>
                    <button @click="triggerDelete" class="w-full bg-red-50 text-red-500 py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-red-100 transition-colors"><i class="fa-solid fa-trash-can"></i> åˆªé™¤è¡Œç¨‹</button>
                    <button @click="showActionModal = false" class="w-full text-gray-400 py-2 text-sm">å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <div v-if="showModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm" @click.self="closeModal">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl transform transition-all scale-100 flex flex-col max-h-[90vh]">
                <h3 class="text-xl font-bold mb-4 text-center shrink-0">{{ isEditing ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹' }}</h3>
                <div class="space-y-4 overflow-y-auto no-scrollbar flex-1 pb-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-xs text-gray-500 ml-1">é¡åˆ¥</label><select v-model="modalForm.category" class="w-full bg-gray-50 p-3 rounded-xl border border-gray-100"><option value="sight">æ™¯é»</option><option value="food">ç¾é£Ÿ</option><option value="shop">è³¼ç‰©</option><option value="hotel">ä½å®¿</option><option value="traffic">äº¤é€š</option><option value="other">å…¶ä»–</option></select></div>
                        <div><label class="text-xs text-gray-500 ml-1">æ™‚é–“</label><input type="time" v-model="modalForm.startTime" class="w-full bg-gray-50 p-3 rounded-xl border border-gray-100"></div>
                    </div>
                    <div><label class="text-xs text-gray-500 ml-1">åç¨±</label><input v-model="modalForm.name" class="w-full bg-gray-50 p-3 rounded-xl border border-gray-100" placeholder="è¡Œç¨‹åç¨±"></div>
                    <div><label class="text-xs text-gray-500 ml-1">å€‹äººå‚™è¨»</label><textarea v-model="modalForm.note" class="w-full bg-gray-50 p-3 rounded-xl border border-gray-100" rows="3" placeholder="å¯«ä¸‹ä½ çš„ç­†è¨˜..."></textarea></div>
                </div>
                <div class="flex gap-3 mt-auto pt-2 shrink-0"><button @click="saveItem" class="w-full flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-200 active:bg-blue-700">å„²å­˜</button></div>
            </div>
        </div>

        <div v-if="showDetailModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center p-0 sm:p-4 bg-black/60 backdrop-blur-sm" @click.self="showDetailModal = false">
            <div class="bg-white w-full max-w-sm rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl transform transition-all animate-slide-up max-h-[85vh] overflow-y-auto relative">
                <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6"></div>
                <div class="text-center mb-6">
                    <div :class="['inline-flex items-center justify-center w-16 h-16 rounded-full text-white text-2xl mb-3 shadow-lg', getCategoryColor(selectedDetailItem.category)]"><i :class="getCategoryIcon(selectedDetailItem.category)"></i></div>
                    <h3 class="text-2xl font-bold text-slate-800">{{ selectedDetailItem.name }}</h3>
                    <div class="text-sm text-gray-500 mt-1">{{ selectedDetailItem.time }} Â· {{ selectedDetailItem.businessHours || 'æ™‚é–“ä¾ç¾å ´ç‚ºä¸»' }}</div>
                </div>
                <div class="space-y-4">
                    <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100"><h4 class="font-bold text-blue-800 mb-2 flex items-center"><i class="fa-solid fa-circle-info mr-2"></i> å°éŠä»‹ç´¹ (åœ‹å°ç”Ÿç‰ˆ)</h4><p class="text-sm text-slate-700 leading-relaxed whitespace-pre-line">{{ selectedDetailItem.desc || 'æš«ç„¡ä»‹ç´¹' }}</p></div>
                    <div v-if="selectedDetailItem.mustEat" class="bg-orange-50 p-4 rounded-2xl border border-orange-100"><h4 class="font-bold text-orange-800 mb-2 flex items-center"><i class="fa-solid fa-utensils mr-2"></i> å¿…åƒ / å¿…é€›</h4><p class="text-sm text-slate-700">{{ selectedDetailItem.mustEat }}</p></div>
                    <div v-if="selectedDetailItem.mustBuy" class="bg-purple-50 p-4 rounded-2xl border border-purple-100"><h4 class="font-bold text-purple-800 mb-2 flex items-center"><i class="fa-solid fa-bag-shopping mr-2"></i> å¿…è²·ä¼´æ‰‹ç¦® & è—¥å¦</h4><p class="text-sm text-slate-700">{{ selectedDetailItem.mustBuy }}</p></div>
                    <div v-if="selectedDetailItem.photoTip" class="bg-pink-50 p-4 rounded-2xl border border-pink-100"><h4 class="font-bold text-pink-800 mb-2 flex items-center"><i class="fa-solid fa-camera mr-2"></i> æ‹ç…§æŠ€å·§</h4><p class="text-sm text-slate-700">{{ selectedDetailItem.photoTip }}</p></div>
                    <div v-if="selectedDetailItem.note" class="bg-gray-50 p-4 rounded-2xl border border-gray-100"><h4 class="font-bold text-gray-700 mb-2">æ‚¨çš„å‚™è¨»</h4><p class="text-sm text-gray-600">{{ selectedDetailItem.note }}</p></div>
                </div>
                <button @click="showDetailModal = false" class="w-full bg-slate-800 text-white py-4 rounded-2xl font-bold mt-6 text-lg shadow-lg active:scale-95 transition-transform">é—œé–‰æ”»ç•¥</button>
            </div>
        </div>

        <div v-if="showShoppingModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm" @click.self="showShoppingModal = false"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl"><h3 class="text-xl font-bold mb-4 text-center">{{ isEditingShopping ? 'ç·¨è¼¯å•†å“' : 'æ–°å¢å•†å“' }}</h3><input v-model="shoppingForm.name" class="w-full bg-gray-50 p-3 rounded-xl mb-4" placeholder="å•†å“åç¨±"><div class="mb-4"><label class="block w-full aspect-video bg-gray-50 border-2 border-dashed border-gray-300 rounded-xl flex items-center justify-center cursor-pointer hover:border-blue-400"><span v-if="!shoppingForm.image" class="text-gray-400"><i class="fa-solid fa-camera mr-2"></i>{{ isEditingShopping ? 'æ›´æ›ç…§ç‰‡' : 'ä¸Šå‚³ç…§ç‰‡' }}</span><img v-else :src="shoppingForm.image" class="h-full object-contain"><input type="file" class="hidden" @change="handleImageUpload"></label></div><div class="flex gap-3"><button v-if="isEditingShopping" @click="deleteShoppingItem" class="flex-1 bg-red-100 text-red-500 py-3 rounded-xl font-bold">åˆªé™¤</button><button @click="addShoppingItem" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold">å„²å­˜</button></div></div></div>
        <div v-if="showExpenseModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm" @click.self="showExpenseModal = false"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl"><h3 class="text-xl font-bold mb-4 text-center">{{ isEditingExpense ? 'ç·¨è¼¯èŠ±è²»' : 'æ–°å¢èŠ±è²»' }}</h3><div class="space-y-3"><select v-model="expenseForm.category" class="w-full bg-gray-50 p-3 rounded-xl"><option value="é£²é£Ÿ">é£²é£Ÿ</option><option value="äº¤é€š">äº¤é€š</option><option value="è³¼ç‰©">è³¼ç‰©</option><option value="é–€ç¥¨">é–€ç¥¨</option><option value="ä½å®¿">ä½å®¿</option><option value="å…¶ä»–">å…¶ä»–</option></select><input v-model="expenseForm.name" class="w-full bg-gray-50 p-3 rounded-xl" placeholder="é …ç›®åç¨±"><input type="number" v-model="expenseForm.amount" class="w-full bg-gray-50 p-3 rounded-xl" placeholder="é‡‘é¡ (JPY)"><div class="bg-gray-50 p-3 rounded-xl border border-gray-100 space-y-2"><label class="text-xs text-gray-500 block">ä»˜æ¬¾æ–¹å¼</label><select v-model="expenseForm.paymentType" class="w-full bg-white p-2 rounded-lg border border-gray-200"><option value="ç¾é‡‘">ç¾é‡‘</option><option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option></select><div v-if="expenseForm.paymentType === 'ä¿¡ç”¨å¡'"><input v-model="expenseForm.customName" list="used-cards-list" class="w-full bg-white p-2 rounded-lg border border-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-200" placeholder="è¼¸å…¥æˆ–é¸æ“‡å¡ç‰‡ (å¦‚: åœ‹æ³°CUBE)"><datalist id="used-cards-list"><option v-for="card in usedCards" :value="card"></option></datalist></div></div></div><div class="flex gap-3 mt-4"><button v-if="isEditingExpense" @click="deleteExpense" class="flex-1 bg-red-100 text-red-500 py-3 rounded-xl font-bold active:bg-red-200">åˆªé™¤</button><button @click="saveExpense" class="flex-1 bg-emerald-500 text-white py-3 rounded-xl font-bold active:bg-emerald-600">å„²å­˜</button></div></div></div>
        <div v-if="showStatsModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm" @click.self="showStatsModal = false"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl h-[80vh] overflow-y-auto no-scrollbar"><h3 class="text-xl font-bold mb-6 text-center text-slate-800">ğŸ“Š æ¶ˆè²»çµ±è¨ˆè¡¨</h3><div class="mb-8"><h4 class="text-sm font-bold text-gray-500 mb-3 ml-1">æ”¯ä»˜æ–¹å¼å æ¯”</h4><div class="space-y-4"><div v-for="(amount, method) in cardBreakdown" :key="method" class="bg-gray-50 rounded-xl p-3 border border-gray-100"><div class="flex justify-between items-center mb-2"><span class="font-bold text-slate-700 flex items-center gap-2"><i v-if="method==='ç¾é‡‘'" class="fa-solid fa-money-bill-1 text-green-500"></i><i v-else class="fa-regular fa-credit-card text-blue-500"></i>{{ method }}</span><span class="font-bold">Â¥ {{ amount.toLocaleString() }}</span></div><div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden"><div class="bg-blue-500 h-2 rounded-full animate-bar" :style="{ width: (totalExpenses > 0 ? (amount / totalExpenses * 100) : 0) + '%' }"></div></div><div class="text-right text-xs text-gray-400 mt-1">{{ totalExpenses > 0 ? Math.round(amount / totalExpenses * 100) : 0 }}%</div></div></div></div><div><h4 class="text-sm font-bold text-gray-500 mb-3 ml-1">æ¶ˆè²»é¡åˆ¥åˆ†æ</h4><div class="space-y-3"><div v-for="(amount, cat) in categoryBreakdown" :key="cat" class="flex items-center gap-3"><div :class="['w-8 h-8 rounded-full flex items-center justify-center text-white text-xs shrink-0', getExpenseColor(cat)]"><i :class="getExpenseIcon(cat)"></i></div><div class="flex-1"><div class="flex justify-between text-sm mb-1"><span class="font-bold text-slate-700">{{ cat }}</span><span>Â¥ {{ amount.toLocaleString() }}</span></div><div class="w-full bg-gray-100 rounded-full h-1.5"><div :class="['h-1.5 rounded-full animate-bar', getExpenseColor(cat)]" :style="{ width: (totalExpenses > 0 ? (amount / totalExpenses * 100) : 0) + '%' }"></div></div></div></div></div></div><button @click="showStatsModal = false" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold mt-8 shadow-lg">é—œé–‰å ±è¡¨</button></div></div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                const currentTab = ref('itinerary');
                const currentDayIndex = ref(0);
                const showModal = ref(false);
                const showDetailModal = ref(false);
                const showShoppingModal = ref(false);
                const showExpenseModal = ref(false);
                const showStatsModal = ref(false);
                const showActionModal = ref(false);
                const selectedActionItem = ref({});
                const isEditing = ref(false);
                const isEditingExpense = ref(false);
                const isEditingShopping = ref(false); 
                const editingShoppingIndex = ref(null); 
                const bannerImage = ref('banner.jpg');
                const selectedDetailItem = ref({});

                const exchangeRate = ref(0.22);
                const calcJpy = ref('');
                const calculatedTwd = computed(() => {
                    return calcJpy.value ? Math.round(calcJpy.value * exchangeRate.value).toLocaleString() : '0';
                });

                const defaultPackingList = [
                    { name: 'é‡è¦è­‰ä»¶èˆ‡éŒ¢åŒ…', items: [{ name: 'è­·ç…§ (æª¢æŸ¥æœŸé™)', checked: false }, { name: 'æ—¥å¹£ç¾é‡‘', checked: false }, { name: 'ä¿¡ç”¨å¡ (é–‹å•Ÿæµ·å¤–ææ¬¾)', checked: false }, { name: 'VJW æˆªåœ–', checked: false }] },
                    { name: 'è¡£ç‰©èˆ‡ä¿æš–', items: [{ name: 'ç¾½çµ¨å¤–å¥—', checked: false }, { name: 'ç™¼ç†±è¡£', checked: false }, { name: 'æ¯›å¸½/æ‰‹å¥—', checked: false }, { name: 'å¥½èµ°çš„é‹', checked: false }] },
                    { name: '3C èˆ‡è—¥å“', items: [{ name: 'æ‰‹æ©Ÿ/å……é›»ç·š', checked: false }, { name: 'è¡Œå‹•é›»æº (å¿…å‚™)', checked: false }, { name: 'ç¶²å¡é‡', checked: false }, { name: 'å¸¸å‚™è—¥/OKç¹ƒ', checked: false }] }
                ];
                const packingList = ref(JSON.parse(JSON.stringify(defaultPackingList)));
                const newPackingInputs = ref({}); 

                const tripDays = ref([
                    { date: '2/4', weekday: 'Wed', fullDate: '2026-02-04', location: 'å¤§é˜ª/æ¢…ç”°', weather: { temp: 8, feels: 5, icon: 'fa-solid fa-cloud', desc: 'å¤šé›²æ™‚é™°' }, mustBring: 'è­·ç…§ã€VJW æˆªåœ–ã€å¤§è¡Œæç®±(ç©ºä¸€åŠ)ã€è¡Œå‹•é›»æºã€‚' },
                    { date: '2/5', weekday: 'Thu', fullDate: '2026-02-05', location: 'å¤§é˜ª/USJ', weather: { temp: 6, feels: 2, icon: 'fa-solid fa-sun', desc: 'æ™´æ™‚å¤šé›²' }, mustBring: 'USJ APP (å…ˆä¸‹è¼‰)ã€å…©é¡†æ»¿é›»çš„è¡Œå‹•é›»æº (ç©é¦¬åŠ›æ­æœƒè€—é›»)ã€æš–æš–åŒ… (æµ·é‚Šé¢¨å¤§)ã€å¸½å­æ‰‹å¥—ã€‚' },
                    { date: '2/6', weekday: 'Fri', fullDate: '2026-02-06', location: 'æœ‰é¦¬æº«æ³‰', weather: { temp: 4, feels: 0, icon: 'fa-regular fa-snowflake', desc: 'å¯èƒ½ä¸‹é›ª' }, mustBring: 'è¼•ä¾¿éå¤œåŒ… (æ›æ´—è¡£ç‰©)ã€å„ç¨®å……é›»ç·šã€‚å¤§è¡Œæè¨˜å¾—æ—©ä¸Šå¯„å‡ºï¼' },
                    { date: '2/7', weekday: 'Sat', fullDate: '2026-02-07', location: 'äº¬éƒ½', weather: { temp: 5, feels: 2, icon: 'fa-solid fa-cloud-sun', desc: 'å¤šé›²' }, mustBring: 'ç©ºçš„èƒƒ (åƒéŒ¦å¸‚å ´)ã€å¥½èµ°çš„é‹ã€‚' },
                    { date: '2/8', weekday: 'Sun', fullDate: '2026-02-08', location: 'äº¬éƒ½', weather: { temp: 7, feels: 4, icon: 'fa-solid fa-sun', desc: 'æ™´æœ—' }, mustBring: 'é˜²æ»‘çš„é‹ (çŒ´å­å…¬åœ’æ˜¯æ³¥åœŸè·¯)ã€é›¶éŒ¢ (è²·é£¼æ–™é¤µçŒ´å­)ã€‚' },
                    { date: '2/9', weekday: 'Mon', fullDate: '2026-02-09', location: 'é—œè¥¿æ©Ÿå ´', weather: { temp: 9, feels: 6, icon: 'fa-solid fa-cloud', desc: 'å¤šé›²' }, mustBring: 'è­·ç…§ (æ”¾åœ¨å¥½æ‹¿çš„åœ°æ–¹)ã€å‰©é¤˜çš„æ—¥å¹£é›¶éŒ¢ (è½‰æ‰­è›‹)ã€‚' },
                ]);

                const itineraryData = ref({
                    0: [ 
                        { id: 1, type: 'flight', category: 'flight', name: 'è¯èˆª CI152', time: '13:20', flightInfo: { depCode: 'TPE', arrCode: 'KIX', number: 'CI152' }, note: 'æ©Ÿä¸Šå…ˆå¡« VJW', desc: 'å°æœ‹å‹è«‹åœ¨é£›æ©Ÿä¸Šç¡é£½ï¼Œä¸‹æ©Ÿå¾Œè¦èµ°å¾ˆå¤šè·¯ï¼è¨˜å¾—æŠŠ VJW çš„ QR Code æˆªåœ–å­˜åœ¨çˆ¸åª½æ‰‹æ©Ÿè£¡ã€‚', transit: null },
                        { id: 2, type: 'normal', category: 'traffic', name: 'å‰å¾€è‡¨ç©ºåŸ Outlet', time: '14:50', note: 'JR é—œç©ºå¿«é€Ÿ', desc: 'åªè¦åä¸€ç«™ç«è»Šå°±åˆ°äº†ï¼è¡Œæå¯ä»¥å¯„æ”¾åœ¨è»Šç«™ï¼Œæˆ–æ˜¯Outletè£¡é¢çš„ç½®ç‰©æ«ƒã€‚', transit: { type: 'train', duration: '9åˆ†' } },
                        { id: 3, type: 'normal', category: 'shop', name: 'Rinku Premium Outlets', time: '15:10', businessHours: '10:00-20:00', tags: ['ä¾¿å®œè—¥å¦', 'å¤•é™½'], note: 'é ˜å¤–åœ‹äºº Coupon', 
                          desc: 'ã€åœ‹å°ç”Ÿçœ‹é»ã€‘é€™è£¡æœ‰å¾ˆå¤§çš„ Lego æ¨‚é«˜åº—å’Œ Sanrio ä¸‰éº—é·—(Hello Kitty)ã€‚\nã€ä¾¿å®œè—¥å¦ã€‘Daikoku (å¤§åœ‹è—¥å¦) åœ¨ Seacle å•†å ´ 1 æ¨“ï¼Œæ¯”å¸‚å€ä¾¿å®œï¼', 
                          mustEat: 'Kua Aina å¤å¨å¤·æ¼¢å ¡ (è–¯æ¢å¾ˆç´°å¾ˆå¥½åƒ)ã€Snow Peak Eat (å¯ä»¥åœ¨å¸³ç¯·è£¡åƒé£¯)ã€‚', 
                          mustBuy: 'Skechers (çˆ¸åª½èµ°è·¯ç¥é‹)ã€Nikeã€Adidasã€‚', 
                          photoTip: 'ä¸‹åˆ 5:20 å»ã€ŒSea Side Areaã€æµ·é‚Šï¼Œå¯ä»¥æ‹åˆ°æ‘©å¤©è¼ªï¼‹å¤•é™½ï¼‹å¤§æµ·çš„ç„¡æ•µåˆç…§ã€‚',
                          transit: { type: 'walk', duration: '5åˆ†' } },
                        { id: 4, type: 'normal', category: 'traffic', name: 'å‰å¾€å¤§é˜ªæ¢…ç”°', time: '18:30', note: 'å‰ 4 ç¯€è»Šå»‚', desc: 'æ³¨æ„ï¼ç«è»Šæœƒã€Œåˆ†èº«ã€ï¼Œä¸€å®šè¦ååœ¨ç¬¬ 1 åˆ°ç¬¬ 4 ç¯€è»Šå»‚ï¼Œä¸ç„¶æœƒè¢«è¼‰å»åˆ¥çš„åœ°æ–¹å–”ã€‚', transit: { type: 'train', duration: '55åˆ†' } },
                        { id: 5, type: 'normal', category: 'hotel', name: 'Check-in: Vischio Osaka', time: '19:30', note: 'æ¢…ç”°è¿·å®®æ”»ç•¥', desc: 'ã€æ¢…ç”°å¤§è¿·å®®ã€‘ä¸è¦èµ°åœ°ä¸‹è¡—ï¼å‡ºä¾†å¾Œæ‰¾ã€Œ2æ¨“å¤©æ©‹ã€ï¼Œå¾ Grand Front ç©¿éå»å°±åˆ°äº†ã€‚', transit: { type: 'walk', duration: '10åˆ†' } },
                        { id: 6, type: 'normal', category: 'food', name: 'è—å£½å¸ æ¢…ç”°æ——è‰¦åº—', time: '20:00', tags: ['è¦ªå­å‹å–„'], note: 'å¯é ç´„', 
                          desc: 'ã€åœ‹å°ç”Ÿçœ‹é»ã€‘é€™å®¶æ˜¯å…¨ä¸–ç•Œæœ€å¤§çš„è—å£½å¸ï¼æœ‰ç¥­å…¸éŠæˆ²å¯ä»¥ç©ï¼Œç›¤å­ä¸Ÿé€²å»å¯ä»¥æŠ½æ‰­è›‹ã€‚', 
                          mustEat: 'ç‚™ç‡’é®­é­šã€èŒ¶ç¢—è’¸ (æ—¥æœ¬çš„ç‰¹åˆ¥å¥½åƒ)ã€‚', 
                          photoTip: 'å…¥å£æœ‰ä¸€é¢å·¨å¤§çš„ã€Œå½©è‰²ç‡ˆç± ç‰†ã€ï¼Œä¸€å®šè¦åœ¨é€™è£¡æ‹å…¨å®¶ç¦ã€‚',
                          transit: { type: 'walk', duration: '5åˆ†' } }
                    ],
                    1: [
                        { id: 10, type: 'normal', category: 'traffic', name: 'å‡ºç™¼å‰å¾€ USJ', time: '07:00', note: 'JR ç’°ç‹€ç·š->å¤¢å’²ç·š', desc: 'è·Ÿè‘—äººç¾¤èµ°å°±å°äº†ï¼å¤§å®¶éƒ½è¦å»ç’°çƒå½±åŸã€‚', transit: { type: 'hotel', duration: '30åˆ†' } },
                        { id: 11, type: 'normal', category: 'sight', name: 'USJ å…¥åœ’ & æŠ½æ•´ç†åˆ¸', time: '07:45', ticket: 'QR Code', note: 'ç«‹åˆ»æŠ½ç‘ªåˆ©æ­', 
                          desc: 'ã€åœ‹å°ç”Ÿçœ‹é»ã€‘çœŸå¯¦çš„é›»ç©ä¸–ç•Œï¼ä¸€é€²é–€çˆ¸çˆ¸åª½åª½è¦è¶•å¿«ç”¨æ‰‹æ©ŸæŠ½ã€Œç‘ªåˆ©æ­æ¨‚åœ’ã€çš„è™Ÿç¢¼ç‰Œã€‚', 
                          mustBuy: 'èƒ½é‡æ‰‹ç’° (å¯ä»¥æ•²é‡‘ç£šè³ºé‡‘å¹£)ã€æ˜Ÿæ˜Ÿçˆ†ç±³èŠ±æ¡¶ (æœƒç™¼å…‰)ã€‚', 
                          photoTip: 'ä¸€é€²é–€çš„å¤§åœ°çƒğŸŒæ˜¯å¿…æ‹ï¼Œè«‹è·¯äººå¹«å¿™æ‹åˆç…§ï¼Œç¨å¾®ç”±ä¸‹å¾€ä¸Šæ‹è…¿æœƒæ¯”è¼ƒé•·ã€‚',
                          transit: { type: 'walk', duration: '5åˆ†' } },
                        { id: 12, type: 'normal', category: 'sight', name: 'å°å°å…µ & è¦ªå­å€', time: '08:30', note: 'èº«é«˜é™åˆ¶æ³¨æ„', 
                          desc: 'ã€åœ‹å°ç”Ÿçœ‹é»ã€‘å°å°å…µæœƒå‡ºä¾†æƒ¡ä½œåŠ‡ï¼ã€Œå°å°å…µä¹˜è»ŠéŠã€å¦‚æœèº«é«˜ä¸å¤  (102cm)ï¼Œå¯ä»¥å»æ—é‚Šçš„ã€Œç’°çƒå¥‡å¢ƒã€é–‹å²åŠªæ¯”é£›æ©Ÿã€‚', 
                          mustEat: 'å°å°å…µå¤¾å¿ƒé¤…ä¹¾ (Minion Cookie Sand)ã€‚', 
                          transit: { type: 'walk', duration: '10åˆ†' } },
                        { id: 13, type: 'normal', category: 'food', name: 'å¿«æ¨‚å’–å•¡å»³åˆé¤', time: '11:00', note: 'Happiness Cafe', 
                          desc: 'é€™è£¡æœ‰é£²æ–™å–åˆ°é£½ï¼ä¼‘æ¯ä¸€ä¸‹ï¼Œä¸Šå€‹å»æ‰€ï¼Œæº–å‚™ä¸‹åˆå†æˆ°ã€‚', 
                          mustEat: 'å°å°å…µæ¼¢å ¡é¤ (é€ å‹å¾ˆå¯æ„›)ã€‚', 
                          transit: { type: 'walk', duration: '5åˆ†' } },
                        { id: 14, type: 'normal', category: 'sight', name: 'NO LIMIT! Parade', time: '14:00', note: 'éŠè¡Œ', desc: 'æœƒæœ‰çš®å¡ä¸˜ã€ç‘ªåˆ©æ­å‡ºä¾†è·³èˆï¼å¤§å®¶è¦ä¸€èµ·è·Ÿè‘—éŸ³æ¨‚æ®æ‰‹å–”ã€‚', transit: { type: 'walk', duration: '0åˆ†' } },
                        { id: 15, type: 'normal', category: 'sight', name: 'è¶…ç´šä»»å¤©å ‚ä¸–ç•Œ', time: '15:30', note: 'éœ€æ†‘åˆ¸å…¥å ´', 
                          desc: 'ã€åœ‹å°ç”Ÿçœ‹é»ã€‘çœŸçš„é€²åˆ°é¦¬åŠ›æ­éŠæˆ²è£¡äº†ï¼å¯ä»¥ç”¨æ‰‹ç’°å»æ•²ç£šå¡Šã€æ‰“é­”ç‹ã€‚æ³¨æ„ï¼šä¸€å®šè¦é‡èº«é«˜ï¼Œå·®1å…¬åˆ†ä¹Ÿä¸èƒ½ç©è³½è»Šå–”ã€‚', 
                          mustEat: 'å¥‡è«¾æ¯”å¥§é¤å»³ (è˜‘è‡æ¿ƒæ¹¯)ã€‚', 
                          photoTip: 'åœ¨ç¶ è‰²æ°´ç®¡è£¡é¢æ‹ç…§ï¼Œåƒå‰›å¾æ°´ç®¡é‘½å‡ºä¾†ä¸€æ¨£ã€‚',
                          transit: { type: 'walk', duration: '15åˆ†' } },
                        { id: 16, type: 'normal', category: 'sight', name: 'å“ˆåˆ©æ³¢ç‰¹ç¦å¿Œä¹‹æ—…', time: '18:00', note: 'èº«é«˜122cm', 
                          desc: 'ã€åœ‹å°ç”Ÿçœ‹é»ã€‘æœ‰çœŸçš„è²“é ­é·¹ï¼æ™šä¸Šçš„éœæ ¼è¯èŒ²åŸå ¡æœƒç™¼å…‰ï¼Œè¶…ç´šæ¼‚äº®ã€‚', 
                          mustEat: 'å¥¶æ²¹å•¤é…’ (é€™æ˜¯æ²’æœ‰é…’ç²¾çš„æ±½æ°´ï¼Œå°æœ‹å‹å¯ä»¥å–ï¼Œå˜´å·´æœƒæœ‰ç™½é¬å­)ã€‚', 
                          photoTip: 'å»ã€Œä¸‰æ ¹æƒå¸šã€é¤å»³å¾Œé¢çš„æˆ¶å¤–åº§ä½ï¼Œå¯ä»¥æ‹åˆ°æœ€å®Œæ•´çš„åŸå ¡å€’å½±ï¼Œé‚„æ²’æœ‰äººæ“ äººã€‚',
                          transit: { type: 'walk', duration: '10åˆ†' } },
                        { id: 17, type: 'normal', category: 'food', name: '551 è“¬èŠè‚‰åŒ…', time: '20:30', note: 'å®µå¤œ', desc: 'åœ¨è»Šç«™å¤–é¢è²·å¤§é˜ªæœ€æœ‰åçš„è‚‰åŒ…å›é£¯åº—åƒã€‚', transit: { type: 'train', duration: '30åˆ†' } }
                    ],
                    2: [
                        { id: 20, type: 'normal', category: 'other', name: 'ã€é‡è¦ã€‘è¡Œæè¨—é‹', time: '08:30', note: 'å¯„å¾€äº¬éƒ½é£¯åº—', desc: 'çˆ¸çˆ¸åª½åª½æ³¨æ„ï¼šæŠŠå¤§è¡Œæç®±å¯„å»äº¬éƒ½ï¼Œæˆ‘å€‘åªå¸¶ä¸€å€‹å°åŒ…åŒ…å»æº«æ³‰æ—…é¤¨ï¼Œåƒå»éœ²ç‡Ÿä¸€æ¨£è¼•é¬†ï¼', transit: { type: 'hotel', duration: '10åˆ†' } },
                        { id: 21, type: 'normal', category: 'sight', name: 'å¤§é˜ªåŸå…¬åœ’', time: '09:30', note: 'æ­å°ç«è»Š', 
                          desc: 'ã€åœ‹å°ç”Ÿçœ‹é»ã€‘é€™æ˜¯å¤ä»£å°‡è»ä½çš„åœ°æ–¹ï¼ŒçŸ³é ­ç‰†å£è¶…ç´šå¤§ï¼æˆ‘å€‘å¯ä»¥åå…¬åœ’è£¡çš„å°ç«è»Šå»çœ‹åŸå ¡ã€‚', 
                          mustEat: 'ç« é­šç‡’ (å…¬åœ’åº—)ã€‚', 
                          photoTip: 'ä¸è¦ç«™åœ¨åŸå ¡æ­£ä¸‹æ–¹æ‹ï¼Œäººæœƒè®Šå¾ˆå°ã€‚ç«™åœ¨è­·åŸæ²³çš„æ©‹ä¸Šæ‹ï¼Œäººè·ŸåŸå ¡éƒ½å¾ˆæ¸…æ¥šã€‚',
                          transit: { type: 'train', duration: '20åˆ†' } },
                        { id: 22, type: 'normal', category: 'traffic', name: 'å‰å¾€æœ‰é¦¬æº«æ³‰', time: '13:30', note: 'é˜ªæ€¥é«˜é€Ÿå·´å£«', desc: 'åèˆ’æœçš„å¤§å·´å£«å»å±±ä¸Šæ³¡æº«æ³‰å›‰ï¼', transit: { type: 'car', duration: '60åˆ†' } },
                        { id: 23, type: 'normal', category: 'hotel', name: 'Check-in: æœ‰é¦¬å…µè¡›å‘é™½é–£', time: '15:00', note: 'é‡‘éŠ€é›™æ¹¯', 
                          desc: 'ã€åœ‹å°ç”Ÿçœ‹é»ã€‘é€™è£¡çš„æº«æ³‰æœ‰å…©ç¨®é¡è‰²ï¼ä¸€ç¨®æ˜¯ç´…è‰²çš„ã€Œé‡‘æ¹¯ã€ï¼Œä¸€ç¨®æ˜¯é€æ˜çš„ã€ŒéŠ€æ¹¯ã€ã€‚', 
                          mustEat: 'æ™šé¤åƒè¶…ç´šé«˜ç´šçš„æ‡·çŸ³æ–™ç† (æœ‰ç‰›è‚‰)ã€‚', 
                          mustBuy: 'ç¢³é…¸å…¥æµ´åŠ‘ (å¯ä»¥è²·å›å®¶æ³¡æ¾¡)ã€‚',
                          photoTip: 'ç©¿è‘—é£¯åº—çš„æµ´è¡£åœ¨æˆ¿é–“çª—é‚Šæ‹ç…§ï¼Œå¾ˆæœ‰æ—¥æœ¬å¡é€šçš„æ„Ÿè¦ºã€‚',
                          transit: { type: 'walk', duration: '5åˆ†' } }
                    ],
                    3: [
                        { id: 30, type: 'normal', category: 'sight', name: 'æœ‰é¦¬æº«æ³‰è¡—æ•£ç­–', time: '09:30', note: 'è³å‘³æœŸé™5ç§’', 
                          desc: 'ã€å¿…åƒæŒ‘æˆ°ã€‘å»ã€Œä¸‰æ´¥æ£®æœ¬é‹ªã€è²·ç¢³é…¸ç…é¤…ï¼Œè€é—†å‰›æ‹¿çµ¦ä½ æ™‚æ˜¯è»Ÿçš„ï¼Œæ•¸ 5 ç§’å°±æœƒè®Šç¡¬è„†ï¼å°æœ‹å‹è¦è¶•å¿«åƒæ‰ï¼', 
                          mustEat: 'ç¾çƒ¤ç¢³é…¸ç…é¤…ã€æº«æ³‰é¥…é ­ã€‚', 
                          transit: { type: 'hotel', duration: '0åˆ†' } },
                        { id: 31, type: 'normal', category: 'traffic', name: 'ç›´é”äº¬éƒ½è»Šç«™', time: '13:00', note: 'é˜ªæ€¥å·´å£«', desc: 'æ­å·´å£«ç›´æ¥å»äº¬éƒ½ï¼Œè»Šä¸Šå¯ä»¥ç¡åˆè¦ºã€‚', transit: { type: 'car', duration: '60åˆ†' } },
                        { id: 32, type: 'normal', category: 'hotel', name: 'Check-in: Daiwa Roynet', time: '15:00', tags: ['ä¾¿å®œè—¥å¦'], note: 'ç¢ºèªè¡Œæ', 
                          desc: 'æˆ‘å€‘çš„è¡Œæå·²ç¶“åœ¨é£¯åº—ç­‰æˆ‘å€‘äº†ï¼\nã€ä¾¿å®œè—¥å¦ã€‘é£¯åº—å°é¢æœ‰ä¸€é–“å¾ˆå¤§çš„ã€ŒDon Quijote (å”å‰è¨¶å¾·)ã€ï¼Œæ™šä¸Šå¯ä»¥å»æ¢éšªã€‚', 
                          transit: { type: 'walk', duration: '5åˆ†' } },
                        { id: 33, type: 'normal', category: 'shop', name: 'éŒ¦å¸‚å ´', time: '16:00', note: '17:00 æ”¶æ”¤', 
                          desc: 'ã€åœ‹å°ç”Ÿçœ‹é»ã€‘é€™æ˜¯äº¬éƒ½çš„å»šæˆ¿ï¼æœ‰å¾ˆå¤šå¥‡æ€ªçš„é£Ÿç‰©ï¼Œåƒç´…è‰²çš„å°ç« é­š(é ­è£¡é¢æœ‰è›‹)ã€‚æ³¨æ„ï¼šè²·äº†è¦åœ¨åº—é–€å£åƒå®Œï¼Œä¸èƒ½é‚Šèµ°é‚Šåƒå–”ã€‚', 
                          mustEat: 'å¯Œç¾å®¶é‹ç‡’çƒé¾éºµ (å¾ˆå¤šæ–™)ã€å²åŠªæ¯”èŒ¶å±‹ (å¯æ„›é¥…é ­)ã€è±†ä¹³ç”œç”œåœˆã€‚', 
                          mustBuy: 'èˆå¦“å’–å“©ä»™è² (è¾£è¾£çš„å¾ˆå¥½åƒ)ã€‚', 
                          transit: { type: 'train', duration: '15åˆ†' } }
                    ],
                    4: [
                        { id: 40, type: 'normal', category: 'sight', name: 'åµå±±çŒ´å­å…¬åœ’', time: '09:00', note: 'éœ€çˆ¬å±±20åˆ†', 
                          desc: 'ã€åœ‹å°ç”Ÿçœ‹é»ã€‘æˆ‘å€‘è¦çˆ¬å±±å»æ‰¾çŒ´å­ï¼å±±é ‚æœ‰ä¸€å€‹å°å±‹å­ï¼Œæˆ‘å€‘èº²åœ¨ç± å­è£¡ï¼ŒçŒ´å­åœ¨å¤–é¢ï¼Œå¯ä»¥æ‹¿è˜‹æœé¤µç‰ å€‘ï¼Œè¶…ç´šå¥½ç©ï¼', 
                          mustEat: 'å±±é ‚è²©è³£éƒ¨çš„è˜‹æœåˆ‡ç‰‡(é¤µçŒ´å­ç”¨ï¼Œä¸èƒ½è‡ªå·±åƒXD)ã€‚', 
                          photoTip: 'è·ŸçŒ´å­åˆç…§æ™‚ã€Œçœ¼ç›ä¸è¦ä¸€ç›´ç›¯è‘—çŒ´å­çœ¼ç›çœ‹ã€ï¼Œç‰ å€‘æœƒä»¥ç‚ºä½ è¦åµæ¶ã€‚çœ‹é¡é ­å°±å¥½ï¼',
                          transit: { type: 'train', duration: 'JR 15åˆ†' } },
                        { id: 41, type: 'normal', category: 'sight', name: 'åµå±±ç«¹æ— & åµé›»é«”é©—', time: '11:30', note: 'åˆé¤+æ•£æ­¥', 
                          desc: 'å»ç«¹æ—çœ‹åƒæ­¦ä¿ ç‰‡ä¸€æ¨£çš„åœ°æ–¹ã€‚ç„¶å¾Œå»ååªæœ‰ä¸€ç¯€è»Šå»‚çš„ç´«è‰²é›»è»Šã€Œåµé›»ã€ï¼Œå®ƒæœƒåœ¨é¦¬è·¯ä¸Šè·‘å–”ï¼', 
                          mustEat: 'ARABICA å’–å•¡ (çˆ¸åª½å–)ã€ç±³é£›å…”éºµåŒ… (å°æœ‹å‹åƒ)ã€‚', 
                          transit: { type: 'walk', duration: 'æ¼«æ­¥' } },
                        { id: 42, type: 'normal', category: 'sight', name: 'é‡‘é–£å¯º', time: '15:00', businessHours: '09:00-17:00', note: 'å¤•é™½é‡‘é–£', 
                          desc: 'ã€åœ‹å°ç”Ÿçœ‹é»ã€‘ä¸€ä¼‘å’Œå°šå¡é€šè£¡çš„é»ƒé‡‘å±‹ï¼æ•´æ£Ÿæˆ¿å­éƒ½æ˜¯ç”¨çœŸçš„é‡‘ç®”è²¼ä¸Šå»çš„ï¼Œé–ƒé–ƒç™¼äº®ã€‚', 
                          mustEat: 'é‡‘ç®”å†°æ·‡æ·‹ (å˜´å·´æœƒé‡‘é‡‘çš„)ã€‚', 
                          mustBuy: 'é‡‘é–£å¯ºå¾¡å®ˆ (ä¿ä½‘è€ƒè©¦100åˆ†)ã€‚', 
                          photoTip: 'ä¸€å®šè¦æ‹åˆ°ã€Œæ°´é‡Œé¢çš„é‡‘é–£å¯ºå€’å½±ã€ï¼Œé‚£æ‰æ˜¯æœ€å²å®³çš„ç…§ç‰‡ã€‚',
                          transit: { type: 'train', duration: 'åµé›»+å·´ 40åˆ†' } },
                        { id: 43, type: 'normal', category: 'food', name: 'æ‹‰éºµå°è·¯æ™šé¤', time: '17:30', note: 'äº¬éƒ½è»Šç«™10F', 
                          desc: 'é€™è£¡æœ‰å…¨æ—¥æœ¬æœ€å¥½åƒçš„æ‹‰éºµé›†åˆï¼åƒé£½å¾Œå»èµ°ã€Œç©ºä¸­èµ°å»Šã€ï¼Œçœ‹æ™šä¸Šçš„äº¬éƒ½å¡”ã€‚', 
                          transit: { type: 'car', duration: 'å·´å£« 40åˆ†' } }
                    ],
                    5: [
                        { id: 50, type: 'normal', category: 'traffic', name: 'å‰å¾€é—œè¥¿æ©Ÿå ´', time: '09:30', note: 'JR HARUKA', desc: 'æ­ Hello Kitty çš„ç«è»Šå»æ©Ÿå ´å›‰ï¼', transit: { type: 'train', duration: '80åˆ†' } },
                        { id: 51, type: 'flight', category: 'flight', name: 'æ˜Ÿå®‡ JX823', time: '14:00', flightInfo: { depCode: 'KIX', arrCode: 'TPE', number: 'JX823' }, tags: ['2026å¿…è²·'], note: 'T1 ç™»æ©Ÿ', 
                          desc: 'ã€æœ€å¾Œè¡åˆºã€‘æŠŠå‰©ä¸‹çš„é›¶éŒ¢å…¨éƒ¨æ‹¿å»è½‰æ‰­è›‹ï¼\nã€2026 å¿…è²·ä¼´æ‰‹ç¦®ã€‘\n1. Grand Calbee (é«˜ç´šåšæ´‹èŠ‹ç‰‡)\n2. BÃ¢ton d\'or (è²´å©¦ Pocky)\n3. è–¯æ¢ä¸‰å…„å¼Ÿ (è¬å¹´ä¸æ•—)\n4. ROYCE ç”Ÿå·§å…‹åŠ› (è¦è²·ä¿å†°è¢‹)', 
                          mustBuy: 'æ‰­è›‹æ©Ÿ (æŠŠé›¶éŒ¢èŠ±å…‰)ã€‚', 
                          transit: { type: 'walk', duration: '10åˆ†' } }
                    ]
                });

                const flightInfos = [
                    { type: 'å»ç¨‹', date: '2026/2/4', dep: 'TPE', arr: 'KIX', depTime: '13:20', arrTime: '16:50', duration: '2h35m', code: 'CI152', terminal: 'æ¡ƒæ©Ÿ T2 / é—œè¥¿ T1' },
                    { type: 'å›ç¨‹', date: '2026/2/9', dep: 'KIX', arr: 'TPE', depTime: '14:00', arrTime: '16:15', duration: '3h15m', code: 'JX823', terminal: 'é—œè¥¿ T1 / æ¡ƒæ©Ÿ T1' }
                ];
                
                const hotelInfos = [
                    { name: 'Hotel Vischio Osaka', engName: 'by Granvia', address: 'å¤§é˜ªåºœå¤§é˜ªå¸‚åŒ—å€èŠç”°2ä¸ç›®4-10', booker: 'Lai You Wen', platform: 'Agoda' },
                    { name: 'æœ‰é¦¬å…µè¡›å‘é™½é–£', engName: 'Arima Onsen Hyoe Koyokaku', address: 'å…µåº«çœŒç¥æˆ¸å¸‚åŒ—åŒºæœ‰é¦¬ç”º1904', booker: 'Li Gen Liang', platform: 'å®˜ç¶²' },
                    { name: 'Daiwa Roynet Hotel', engName: 'Kyoto Terrace Hachijo PREMIER', address: 'äº¬éƒ½å¸‚å—åŒºæ±ä¹æ¡æ±å±±ç‹ç”º14-1', booker: 'Lai You Wen', platform: 'Trip' }
                ];

                const modalForm = ref({});
                const shoppingList = ref([]);
                const shoppingForm = ref({ name: '', image: null });
                const expenses = ref([]);
                const expenseForm = ref({ id: null, category: 'é£²é£Ÿ', name: '', amount: '', paymentType: 'ç¾é‡‘', customName: '', date: '' });

                const currentDayItinerary = computed(() => itineraryData.value[currentDayIndex.value] || []);
                const totalExpenses = computed(() => expenses.value.reduce((sum, item) => sum + item.amount, 0));
                const cashTotal = computed(() => expenses.value.filter(i => i.method === 'ç¾é‡‘' || i.paymentType === 'ç¾é‡‘').reduce((sum, item) => sum + item.amount, 0));
                const cardTotal = computed(() => expenses.value.filter(i => (i.method !== 'ç¾é‡‘' && i.paymentType !== 'ç¾é‡‘')).reduce((sum, item) => sum + item.amount, 0));
                const cardBreakdown = computed(() => {
                    const breakdown = {};
                    expenses.value.forEach(item => {
                        let key = item.method;
                        if (item.paymentType) { if (item.paymentType === 'ç¾é‡‘') key = 'ç¾é‡‘'; else key = item.customName || 'ä¿¡ç”¨å¡'; }
                        breakdown[key] = (breakdown[key] || 0) + item.amount;
                    });
                    return breakdown;
                });
                const usedCards = computed(() => {
                    const cards = new Set();
                    expenses.value.forEach(item => {
                        if(item.paymentType === 'ä¿¡ç”¨å¡' && item.customName) cards.add(item.customName);
                        if(item.method !== 'ç¾é‡‘' && item.method !== 'ä¿¡ç”¨å¡' && item.method) cards.add(item.method);
                    });
                    return Array.from(cards);
                });
                const categoryBreakdown = computed(() => {
                    const breakdown = {};
                    expenses.value.forEach(item => { breakdown[item.category] = (breakdown[item.category] || 0) + item.amount; });
                    return breakdown;
                });

                const getCategoryIcon = (cat) => { const map = { sight: 'fa-camera', food: 'fa-utensils', shop: 'fa-bag-shopping', hotel: 'fa-bed', traffic: 'fa-train-subway', flight: 'fa-plane', other: 'fa-circle' }; return `fa-solid ${map[cat] || 'fa-circle'}`; };
                const getCategoryColor = (cat) => { const map = { sight: 'bg-orange-400', food: 'bg-red-400', shop: 'bg-purple-400', hotel: 'bg-blue-400', traffic: 'bg-gray-400', flight: 'bg-sky-500', other: 'bg-slate-400' }; return map[cat] || 'bg-slate-400'; };
                const getTransitIcon = (type) => { if(type === 'walk') return 'fa-solid fa-person-walking'; if(type === 'car') return 'fa-solid fa-car'; if(type === 'hotel') return 'fa-solid fa-bed'; return 'fa-solid fa-train-subway'; };
                const getExpenseIcon = (cat) => { const map = { 'é£²é£Ÿ': 'fa-utensils', 'äº¤é€š': 'fa-train', 'è³¼ç‰©': 'fa-bag-shopping', 'é–€ç¥¨': 'fa-ticket', 'ä½å®¿': 'fa-bed', 'å…¶ä»–': 'fa-circle' }; return `fa-solid ${map[cat] || 'fa-circle'}`; };
                const getExpenseColor = (cat) => { const map = { 'é£²é£Ÿ': 'bg-red-400', 'äº¤é€š': 'bg-gray-400', 'è³¼ç‰©': 'bg-purple-400', 'é–€ç¥¨': 'bg-orange-400', 'ä½å®¿': 'bg-blue-400', 'å…¶ä»–': 'bg-slate-400' }; return map[cat] || 'bg-slate-400'; };

                // å°èˆªèˆ‡è·¯ç·šè¦åŠƒé‚è¼¯
                const cleanName = (name) => {
                    return name.replace(/Check-in:\s*/i, '').replace(/^å‰å¾€/, '').replace(/ã€.*?ã€‘/g, '').replace(/ï¼ˆ.*?ï¼‰/g, '').trim();
                };

                const openMap = (keyword) => {
                    const url = 'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(cleanName(keyword));
                    window.open(url, '_blank');
                };

                const openRoute = (index) => {
                    const list = currentDayItinerary.value;
                    const destination = cleanName(list[index].name);
                    let origin = '';
                    let mode = 'transit'; // default

                    const type = list[index].transit?.type || 'train';
                    if (type === 'car') mode = 'driving';
                    else if (type === 'walk') mode = 'walking';

                    if (index > 0) {
                        const prevItem = list[index - 1];
                        if (prevItem.type === 'flight') {
                            origin = 'Kansai International Airport';
                        } else {
                            origin = cleanName(prevItem.name);
                        }
                    } else {
                        const hotels = [
                            '', 
                            'Hotel Vischio Osaka', 
                            'Hotel Vischio Osaka', 
                            'Arima Onsen Hyoe Koyokaku', 
                            'Daiwa Roynet Hotel Kyoto Terrace Hachijo', 
                            'Daiwa Roynet Hotel Kyoto Terrace Hachijo' 
                        ];
                        origin = hotels[currentDayIndex.value] || 'Current Location';
                    }

                    const url = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}&travelmode=${mode}`;
                    window.open(url, '_blank');
                };

                const openDetail = (item) => { selectedDetailItem.value = item; showDetailModal.value = true; };
                const openAddModal = () => { isEditing.value = false; modalForm.value = { category: 'sight', transitType: 'walk', startTime: '10:00' }; showModal.value = true; };
                const closeModal = () => { showModal.value = false; };
                
                const openActionModal = (item) => {
                    selectedActionItem.value = item;
                    showActionModal.value = true;
                };

                const triggerEdit = () => {
                    showActionModal.value = false;
                    editItem(selectedActionItem.value);
                };

                const triggerDelete = () => {
                    showActionModal.value = false;
                    confirmDeleteItem(selectedActionItem.value);
                };

                const editItem = (item) => { 
                    isEditing.value = true; 
                    modalForm.value = JSON.parse(JSON.stringify(item)); 
                    modalForm.value.startTime = item.time; 
                    modalForm.value.transitType = item.transit ? item.transit.type : 'train'; 
                    showModal.value = true; 
                };
                
                const confirmDeleteItem = (item) => { if(confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${item.name}ã€å—ï¼Ÿåˆªé™¤å¾Œç„¡æ³•å¾©åŸã€‚`)) { const dayList = itineraryData.value[currentDayIndex.value]; const idx = dayList.findIndex(i => i.id === item.id); if(idx !== -1) dayList.splice(idx, 1); saveToStorage(); } };
                
                const saveItem = () => { 
                    const dayList = itineraryData.value[currentDayIndex.value]; 
                    const newItem = { 
                        id: isEditing.value ? modalForm.value.id : Date.now(), 
                        type: modalForm.value.category === 'flight' ? 'flight' : 'normal', 
                        category: modalForm.value.category, 
                        name: modalForm.value.name, 
                        time: modalForm.value.startTime, 
                        businessHours: modalForm.value.businessHours, 
                        ticket: modalForm.value.ticket, 
                        tags: dayList.find(i => i.id === modalForm.value.id)?.tags || [], // ä¿ç•™ tags
                        note: modalForm.value.note, 
                        // å°éŠè³‡è¨Šï¼šè‹¥ç·¨è¼¯ä¸­æ²’æœ‰ï¼Œå‰‡å˜—è©¦å¾é è¨­è³‡æ–™æ‰¾å›
                        desc: dayList.find(i => i.id === modalForm.value.id)?.desc || '',
                        mustEat: dayList.find(i => i.id === modalForm.value.id)?.mustEat || '',
                        mustBuy: dayList.find(i => i.id === modalForm.value.id)?.mustBuy || '',
                        photoTip: dayList.find(i => i.id === modalForm.value.id)?.photoTip || '',
                        
                        transit: isEditing.value && dayList.find(i => i.id === modalForm.value.id)?.transit ? 
                                 { ...dayList.find(i => i.id === modalForm.value.id).transit, type: modalForm.value.transitType } :
                                 (currentDayIndex.value === 0 && dayList.length === 0 ? null : { type: modalForm.value.transitType }), 
                        flightInfo: modalForm.value.category === 'flight' ? { depCode: 'XXX', arrCode: 'XXX', number: 'FLIGHT' } : null 
                    }; 
                    
                    if (isEditing.value) { 
                        const idx = dayList.findIndex(i => i.id === newItem.id); 
                        dayList[idx] = newItem; 
                    } else { 
                        dayList.push(newItem); 
                    } 
                    dayList.sort((a, b) => a.time.localeCompare(b.time)); 
                    saveToStorage(); 
                    showModal.value = false; 
                };
                
                const deleteItem = () => { confirmDeleteItem(modalForm.value); showModal.value = false; };
                const moveItem = (index, direction) => { const list = itineraryData.value[currentDayIndex.value]; const targetIndex = index + direction; if (targetIndex >= 0 && targetIndex < list.length) { [list[index], list[targetIndex]] = [list[targetIndex], list[index]]; saveToStorage(); } };
                
                const openShoppingModal = () => { isEditingShopping.value = false; shoppingForm.value = { name: '', image: null }; showShoppingModal.value = true; };
                const editShoppingItem = (item, idx) => { isEditingShopping.value = true; editingShoppingIndex.value = idx; shoppingForm.value = { ...item }; showShoppingModal.value = true; };
                const handleImageUpload = (e) => { const file = e.target.files[0]; if(file) { const reader = new FileReader(); reader.onload = (e) => shoppingForm.value.image = e.target.result; reader.readAsDataURL(file); } };
                const addShoppingItem = () => { if(shoppingForm.value.name) { if(isEditingShopping.value) { shoppingList.value[editingShoppingIndex.value] = { ...shoppingForm.value }; } else { shoppingList.value.push({ ...shoppingForm.value }); } saveToStorage(); showShoppingModal.value = false; } };
                const removeShoppingItem = (idx) => { if(confirm('åˆªé™¤æ­¤å•†å“ï¼Ÿ')) { shoppingList.value.splice(idx, 1); saveToStorage(); } };
                const deleteShoppingItem = () => { if(confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å•†å“ï¼Ÿ')) { shoppingList.value.splice(editingShoppingIndex.value, 1); saveToStorage(); showShoppingModal.value = false; } };

                const savePackingList = () => { localStorage.setItem('osaka_trip_packing', JSON.stringify(packingList.value)); };
                const resetPackingList = () => { if(confirm('ç¢ºå®šè¦é‡ç½®ç‚ºé è¨­æ¸…å–®å—ï¼Ÿæ‚¨çš„è‡ªè¨‚é …ç›®å°‡æœƒæ¶ˆå¤±ã€‚')) { packingList.value = JSON.parse(JSON.stringify(defaultPackingList)); savePackingList(); } };
                const addPackingItem = (catIndex) => { const text = newPackingInputs.value[catIndex]; if(text && text.trim() !== '') { packingList.value[catIndex].items.push({ name: text, checked: false }); newPackingInputs.value[catIndex] = ''; savePackingList(); } };
                const removePackingItem = (catIndex, itemIndex) => { if(confirm('ç¢ºå®šè¦åˆªé™¤æ­¤é …ç›®å—ï¼Ÿ')) { packingList.value[catIndex].items.splice(itemIndex, 1); savePackingList(); } };

                const openExpenseModal = () => { isEditingExpense.value = false; expenseForm.value = { id: null, category: 'é£²é£Ÿ', name: '', amount: '', paymentType: 'ç¾é‡‘', customName: '', date: tripDays.value[currentDayIndex.value].fullDate }; showExpenseModal.value = true; };
                const editExpense = (exp) => { isEditingExpense.value = true; expenseForm.value = JSON.parse(JSON.stringify(exp)); if (!expenseForm.value.paymentType) { if (expenseForm.value.method === 'ç¾é‡‘') { expenseForm.value.paymentType = 'ç¾é‡‘'; } else { expenseForm.value.paymentType = 'ä¿¡ç”¨å¡'; expenseForm.value.customName = expenseForm.value.method; } } showExpenseModal.value = true; };
                const saveExpense = () => { if(expenseForm.value.name && expenseForm.value.amount) { const newExpense = { ...expenseForm.value, amount: parseInt(expenseForm.value.amount), id: isEditingExpense.value ? expenseForm.value.id : Date.now(), method: expenseForm.value.paymentType === 'ç¾é‡‘' ? 'ç¾é‡‘' : (expenseForm.value.customName || 'ä¿¡ç”¨å¡') }; if(isEditingExpense.value) { const idx = expenses.value.findIndex(e => e.id === newExpense.id); if(idx !== -1) expenses.value[idx] = newExpense; } else { expenses.value.push(newExpense); } saveToStorage(); showExpenseModal.value = false; } };
                const deleteExpense = () => { if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†èŠ±è²»å—ï¼Ÿ')) { const idx = expenses.value.findIndex(e => e.id === expenseForm.value.id); if(idx !== -1) expenses.value.splice(idx, 1); saveToStorage(); showExpenseModal.value = false; } };

                const saveToStorage = () => {
                    localStorage.setItem('osaka_trip_itinerary', JSON.stringify(itineraryData.value));
                    localStorage.setItem('osaka_trip_shopping', JSON.stringify(shoppingList.value));
                    localStorage.setItem('osaka_trip_expenses', JSON.stringify(expenses.value));
                };

                onMounted(() => {
                    const savedItinerary = localStorage.getItem('osaka_trip_itinerary');
                    const savedShopping = localStorage.getItem('osaka_trip_shopping');
                    const savedExpenses = localStorage.getItem('osaka_trip_expenses');
                    const savedPacking = localStorage.getItem('osaka_trip_packing');

                    // æ™ºæ…§åˆä½µï¼šä¿ç•™ä½¿ç”¨è€…é †åºèˆ‡å‚™è¨»ï¼Œä½†è£œå›å°éŠè³‡è¨Š
                    if(savedItinerary) {
                        const saved = JSON.parse(savedItinerary);
                        for (const dayIndex in saved) {
                            saved[dayIndex].forEach(savedItem => {
                                const defaultDay = itineraryData.value[dayIndex];
                                if(defaultDay) {
                                    const defaultItem = defaultDay.find(i => i.id === savedItem.id);
                                    if(defaultItem) {
                                        savedItem.desc = defaultItem.desc;
                                        savedItem.mustEat = defaultItem.mustEat;
                                        savedItem.mustBuy = defaultItem.mustBuy;
                                        savedItem.photoTip = defaultItem.photoTip;
                                        savedItem.tags = defaultItem.tags;
                                    }
                                }
                            });
                        }
                        itineraryData.value = saved;
                    }
                    
                    if(savedShopping) shoppingList.value = JSON.parse(savedShopping);
                    if(savedExpenses) expenses.value = JSON.parse(savedExpenses).map(e => ({...e, id: e.id || Date.now() + Math.random()}));
                    if(savedPacking) packingList.value = JSON.parse(savedPacking);
                });

                return {
                    currentTab, currentDayIndex, tripDays, currentDayItinerary, bannerImage, flightInfos, hotelInfos,
                    showModal, modalForm, openAddModal, closeModal, editItem, saveItem, deleteItem, moveItem, confirmDeleteItem,
                    openMap, openRoute, openDetail, showDetailModal, selectedDetailItem,
                    openActionModal, showActionModal, selectedActionItem, triggerEdit, triggerDelete, 
                    getCategoryIcon, getCategoryColor, getTransitIcon, exchangeRate, calcJpy, calculatedTwd,
                    shoppingList, showShoppingModal, openShoppingModal, shoppingForm, handleImageUpload, addShoppingItem, removeShoppingItem, editShoppingItem, deleteShoppingItem, isEditingShopping,
                    expenses, totalExpenses, cashTotal, cardTotal, cardBreakdown, categoryBreakdown, showExpenseModal, openExpenseModal, 
                    expenseForm, saveExpense, editExpense, deleteExpense, isEditingExpense, getExpenseIcon, getExpenseColor, showStatsModal, usedCards,
                    packingList, savePackingList, resetPackingList, addPackingItem, removePackingItem, newPackingInputs
                };
            }
        }).mount('#app');
    </script>
</body>
</html>